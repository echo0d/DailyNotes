<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.27" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://echo0d.github.io/DailyNotes/develop/Go/ImprovingGo/1_GoFinal.html"><meta property="og:site_name" content="echo0d-notes"><meta property="og:title" content="1. 基础收尾"><meta property="og:description" content="1. 基础收尾 1.1. 项目结构 在 Go 语言中，经典的项目结构通常遵循一种约定俗成的布局，这有助于使项目更具可读性和易维护性。以下是一个经典的 Go 项目结构示例： cmd/: 包含应用程序的入口点，每个可执行程序应该有一个对应的文件夹。 internal/: 包含项目私有的代码，不希望被外部代码引用。 pkg/: 包含项目的可重用代码包，可以被..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-01-10T05:36:24.000Z"><meta property="article:author" content="echo0d"><meta property="article:tag" content="Go"><meta property="article:modified_time" content="2025-01-10T05:36:24.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"1. 基础收尾","image":[""],"dateModified":"2025-01-10T05:36:24.000Z","author":[{"@type":"Person","name":"echo0d","url":""}]}</script><link rel="alternate" type="application/atom+xml" href="https://echo0d.github.io/DailyNotes/atom.xml" title="echo0d-notes Atom Feed"><link rel="alternate" type="application/json" href="https://echo0d.github.io/DailyNotes/feed.json" title="echo0d-notes JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://echo0d.github.io/DailyNotes/rss.xml" title="echo0d-notes RSS Feed"><title>1. 基础收尾 | echo0d-notes</title><meta name="description" content="1. 基础收尾 1.1. 项目结构 在 Go 语言中，经典的项目结构通常遵循一种约定俗成的布局，这有助于使项目更具可读性和易维护性。以下是一个经典的 Go 项目结构示例： cmd/: 包含应用程序的入口点，每个可执行程序应该有一个对应的文件夹。 internal/: 包含项目私有的代码，不希望被外部代码引用。 pkg/: 包含项目的可重用代码包，可以被...">
    <link rel="preload" href="/DailyNotes/assets/style-Dv7PuMJl.css" as="style"><link rel="stylesheet" href="/DailyNotes/assets/style-Dv7PuMJl.css">
    <link rel="modulepreload" href="/DailyNotes/assets/app-BoR_3jx9.js"><link rel="modulepreload" href="/DailyNotes/assets/1_GoFinal.html-B6sXmyQw.js"><link rel="modulepreload" href="/DailyNotes/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/DailyNotes/assets/index.html-C9fD7emN.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-JUDUwRlH.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/DailySkills.html-D1-XvTya.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/Treasure.html-DLuqkRFl.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1-FileSystem.html-d3i1R-_p.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2-commandExecute.html-BK5BYIDq.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/3-Database.html-BdGLim3y.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/4-JNDI.html-GG4ZWuQD.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/5-reflection.html-DXKfN9f5.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/6-ClassLoader.html-CL5fgOaS.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/7-DynamicProxy.html-CXfGf1DR.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1-JavaEE.html-CztHx3oG.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2-JavaMVC.html-CMujF_MC.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/3-JavaWeb_Servlet.html-C2i3DjGT.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/4-JavaWeb_filter.html-DGkHAivi.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/5-JavaWeb_Listener.html-qy6YKrTG.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/6-CookieAndSession.html-S5IELePx.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/7-JSP.html-26HNhe8G.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/JavaVul.html-CknmVYnL.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/deserialize.html-BIilUFqf.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/GoVul.html-DHeeI1ug.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1-CTF_WEB.html-JmVGCgrd.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-e_9Rgc88.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ExecuteAssembly.html-BTpPMJgf.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/RDI.html-CY2I0-qA.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BGSY98vR.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CjjWeFEW.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1_syntax.html-Bk8HkKxX.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2_VariableTypes.html-BJd8I2-f.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-OMOlMVnJ.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CBDA3PTE.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/JSModularity.html-CEyjESeZ.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-AbyvHZ2l.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/React_Typescript_antd.html-BOXuhEgx.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/Vue.html-DV3c7mcw.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1_JavaBase.html-17jS36Ry.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2_ObjectOriented.html-Cyzh9Lta.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/3_CoreClass.html-D2kL4i_9.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/4_Exception.html-BG13Dzug.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/5_Reflection.html-oCdqE_rb.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/6_Annotation.html-2OzGX59X.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/7_Genericity.html-D20F8bsp.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/8_Native.html-DqCM1Ueq.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CMk6dV3A.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/test_django.html-f-7YrWbW.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CXEO5zJF.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/anti-debug.html-b783Y-Wn.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CQdzWlPn.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1_InformationGathering.html-DEgbmjLq.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2_Intranet_windows.html-Dw8FnMlE.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/3_CDN.html-CKamsQMz.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1_LinuxPersistence.html-D9sOkI_E.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2_WindowsPersistence.html-B2wY72ra.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/3_ProcessInjection.html-BeZQ549v.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/1_Linux.html-Cgg_Ryvs.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2_Windows.html-DuZ0RRhk.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/Intranet_tunnel.html-BVU-gXi7.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/Tamper.html-Ca7rYdXU.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/TracesRemoval.html-BkSpaUiH.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/Burpsuite.html-BKGoObI4.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/SQLmap.html-DNlhbVA2.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/Tunnel.html-B8aQ8Lq6.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/WebShell.html-CyYein7w.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/openwrt.html-C_5gqeQj.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/2_fscanPro.html-CO20VXoP.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-A1IK2tA3.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CntYhhdQ.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch1.html-DvBMleWV.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch10.html-DuxrgT0s.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch11.html-BKrVbMAa.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch12.html-C4QuxfFY.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch2.html-BkF9rti5.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch3.html-B-kdFtna.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch4.html-Bt1HXVaI.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch5.html-DgSOqNXU.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch6.html-SZeyRN99.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/ch7.html-DjecrysD.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/node_CVE-2017-14849.html-uiizNSIC.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/tomcat_CVE-2017-12615.html-DnzeLm1f.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/tomcat_CVE-2020-1938.html-BJC7aXKj.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/weblogic_CVE-2017-10271.html-CjGcY1AK.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/weblogic_CVE-2018-2894.html-DUmxXCpg.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/weblogic_CVE-2020-14882.html-D3hN9iQb.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/FastjsonVul.html-DMdnC8bm.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/log4j2 .html-B95R_2F7.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/shiro.html-DGLO0Atv.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/shiro_CVE-2019-12422_shiro721.html-CbZUfmH_.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/shiro_CVE-2020-11989.html-B02hDTqS.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/shiro_CVE-2020-13933.html-IFC2SaGs.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/spring.html-DsgXsA9z.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/spring_CVE-2018-1273_bypass.html-BDuC8Ucf.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/supervisor_CVE-2017-11610.html-DGhXo0Jj.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/xstream_CVE-2021-21351.html-DNP0h4rj.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/C3.html-C6LXGRtU.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/CS.html-CaxtDtdW.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/MSFUse.html-xfGkj49L.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/MSF_CS.html-Bfdv3RfS.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/404.html-DgaYdaFY.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DFXyc9Zi.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Bc54e9iM.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DNzt1Heb.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BGeTE-zX.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CAP0EoxX.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-D4tLm17z.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BH8IvGf_.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-zRAGJZBu.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-YQVIEMWK.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-rEzGZySe.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-ypW2mH8Y.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CMUUy-dm.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DocFR385.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-C-Y8cm4P.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-lOVVDLp2.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BQxyGXSy.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-B8LFKdld.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DXTI2NDt.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Ds_u7Otg.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DxWBUOuq.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BYi1gj0V.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-4NUWxjtc.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DSX4xDFW.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-D7yaFqH7.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-FOsuaNs7.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BSGKVQ8T.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-6WHFRbKg.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-U-oWQt7e.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-l-teuLum.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CG4lEjVV.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-B-JpG3u5.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-B6TGnW_a.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CGXpby2X.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CEfLlimu.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-U-xSsuVg.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Ci5kiixW.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CdVyP6sJ.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DcbkaQju.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DI-zGjf6.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-rPRAJw44.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BZJf0uDh.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Q-ytsly6.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BhJMaizt.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-ib4Phej4.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BarvBs9o.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BebtEzZ0.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-A7nlYEza.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DaNaM_gR.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Vn2jRlYz.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-BZcsQUF9.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-B_yCiQ22.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-B128Pykg.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-R9pUfcB6.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-xYmY0qvK.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CiXAB1TM.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-C1qriSKs.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CbzQxACB.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CHDpcvGK.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-jRAyHVEH.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-D6-yTuW9.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-iHE3EB1P.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DqkbiwoA.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Cobbfn47.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DK5-Xp8h.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CEM-x2JA.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CzBYMleB.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-C0mo70VJ.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-ChOGeKQw.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-B-QRyDvR.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-CJypHt-z.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-Bs9dQXIR.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html--k_SjgFd.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/index.html-DfZrPqIS.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/photoswipe.esm-CMg0yb1C.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/SearchResult-55qwV5WT.js" as="script"><link rel="prefetch" href="/DailyNotes/assets/setupDevtools-7MC2TMWH-OI-7sZGZ.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/DailyNotes/"><img class="vp-nav-logo" src="/DailyNotes/logo.jpg" alt><!----><span class="vp-site-name hide-in-pad">echo0d-notes</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/DailyNotes/CyberSecurity/" aria-label="网络安全"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>网络安全<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/DailyNotes/CodeAudittutorial/" aria-label="代码审计"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>代码审计<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link active" href="/DailyNotes/develop/" aria-label="开发技术"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>开发技术<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/DailyNotes/others/" aria-label="其他随笔"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>其他随笔<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/echo0d/DailyNotes" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable active"><!----><a class="route-link nav-link active vp-sidebar-title" href="/DailyNotes/develop/" aria-label="开发技术"><!---->开发技术<!----></a><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">C 语言</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">C++笔记</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">前端</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Go</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Go语言圣经</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Go语言精进</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/DailyNotes/develop/Go/ImprovingGo/" aria-label="Go语言精进"><!---->Go语言精进<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/DailyNotes/develop/Go/ImprovingGo/1_GoFinal.html" aria-label="1. 基础收尾"><!---->1. 基础收尾<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/DailyNotes/develop/Go/ImprovingGo/2_fscanPro.html" aria-label="2. Go练习-fscan"><!---->2. Go练习-fscan<!----></a></li></ul></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Java</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Other</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">PHP</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Python</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Rust</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->1. 基础收尾</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">echo0d</span></span><span property="author" content="echo0d"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-08-18T14:17:30.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 24 分钟</span><meta property="timeRequired" content="PT24M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category0 clickable" role="navigation">Go</span><!--]--><meta property="articleSection" content="Go"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag0 clickable" role="navigation">Go</span><!--]--><meta property="keywords" content="Go"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-1-项目结构">1.1. 项目结构</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-2-defer函数">1.2. defer函数</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#基本语法">基本语法</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#示例用途">示例用途</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#哪些函数可以defer">哪些函数可以defer</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-3-receiver参数">1.3. receiver参数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-4-变长参数函数">1.4. 变长参数函数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-5-模拟函数重载">1.5. 模拟函数重载</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-6-功能选项">1.6. 功能选项</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-7-go常见的并发模式">1.7. Go常见的并发模式</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#创建模式">创建模式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#退出模式">退出模式</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#管道模式">管道模式</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-8-有缓和无缓channel">1.8. 有缓和无缓channel</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#特点">特点</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#使用场景">使用场景</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-9-cgo-go调用c代码">1.9. cgo-Go调用C代码</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="_1-基础收尾" tabindex="-1"><a class="header-anchor" href="#_1-基础收尾"><span>1. 基础收尾</span></a></h1><h2 id="_1-1-项目结构" tabindex="-1"><a class="header-anchor" href="#_1-1-项目结构"><span>1.1. 项目结构</span></a></h2><p>在 Go 语言中，经典的项目结构通常遵循一种约定俗成的布局，这有助于使项目更具可读性和易维护性。以下是一个经典的 Go 项目结构示例：</p><pre><code>project-root/
|-- cmd/
|   |-- main.go
|
|-- internal/
|   |-- pkg1/
|   |   |-- ...
|   |
|   |-- pkg2/
|   |   |-- ...
|   |
|   |-- ...
|
|-- pkg/
|   |-- pkg3/
|   |   |-- ...
|   |
|   |-- pkg4/
|   |   |-- ...
|   |
|   |-- ...
|
|-- api/
|   |-- http/
|   |   |-- ...
|   |
|   |-- grpc/
|   |   |-- ...
|   |
|   |-- ...
|
|-- configs/
|   |-- config.go
|
|-- deployments/
|   |-- docker/
|   |   |-- Dockerfile
|   |
|   |-- kubernetes/
|   |   |-- ...
|   |
|   |-- ...
|
|-- docs/
|   |-- ...
|
|-- pkg/
|   |-- ...
|
|-- scripts/
|   |-- ...
|
|-- test/
|   |-- ...
|
|-- .gitignore
|-- go.mod
|-- go.sum
|-- README.md
</code></pre><ul><li><strong>cmd/</strong>: 包含应用程序的入口点，每个可执行程序应该有一个对应的文件夹。</li><li><strong>internal/</strong>: 包含项目私有的代码，不希望被外部代码引用。</li><li><strong>pkg/</strong>: 包含项目的可重用代码包，可以被其他项目引用。</li><li><strong>api/</strong>: 包含项目的 API 定义，例如 HTTP 和 gRPC 的端点。</li><li><strong>configs/</strong>: 包含项目的配置文件。</li><li><strong>deployments/</strong>: 包含部署相关的文件，例如 Dockerfile 和 Kubernetes 配置。</li><li><strong>docs/</strong>: 包含项目文档和说明。</li><li><strong>scripts/</strong>: 包含项目的脚本文件。</li><li><strong>test/</strong>: 包含项目的测试代码。</li><li><strong>.gitignore</strong>: Git 忽略文件列表。</li><li><strong>go.mod</strong> 和 <strong>go.sum</strong>: Go modules 文件，用于管理项目依赖。</li><li><strong>README.md</strong>: 项目的说明文件。</li></ul><p>这种结构有助于组织和管理代码，同时也提供了清晰的分层结构和可扩展性。项目结构可能会因项目规模和需求而有所不同，但上述示例代表了一个通用的 Go 项目结构。</p><h2 id="_1-2-defer函数" tabindex="-1"><a class="header-anchor" href="#_1-2-defer函数"><span>1.2. defer函数</span></a></h2><p>在 Go 语言中，<code>defer</code> 语句用于延迟（defer）函数的执行直到包含 <code>defer</code> 语句的函数执行完毕。<code>defer</code> 语句允许在函数执行的任何时候注册一个函数调用，该函数会在函数执行完毕时被调用。这种机制通常用于确保资源在函数执行完毕后得到正确释放，以及在函数返回之前执行清理操作。</p><p>defer的运行机制决定了无论函数是执行到函数体末尾正常返回，还是在函数体中的某个错误处理分支显式调用return返回，或函数体内部出现panic，已经注册了的deferred函数都会被调度执行。</p><h3 id="基本语法" tabindex="-1"><a class="header-anchor" href="#基本语法"><span><strong>基本语法</strong></span></a></h3><pre><code>func someFunction() {
    defer fmt.Println(&quot;This will be executed last&quot;)
    
    // Other function logic
}
</code></pre><h3 id="示例用途" tabindex="-1"><a class="header-anchor" href="#示例用途"><span><strong>示例用途</strong></span></a></h3><p><strong>资源释放</strong>：<code>defer</code> 经常用于关闭文件、释放锁、关闭数据库连接等操作，确保资源得到正确释放。</p><pre><code class="language-go"><span class="token keyword">func</span> <span class="token function">readFile</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 在函数返回前关闭文件</span>
    <span class="token comment">// 读取文件内容</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>跟踪执行</strong>：<code>defer</code> 可以用于跟踪函数的执行情况。</p><pre><code class="language-go"><span class="token keyword">func</span> <span class="token function">printStartAndEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Function end&quot;</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Function start&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>处理错误</strong>：<code>defer</code> 可以用于处理错误，确保清理操作在函数返回时执行。</p><pre><code class="language-go"><span class="token keyword">func</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理错误</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">someFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 可能引发 panic 的代码</span>
<span class="token punctuation">}</span>
</code></pre><p><code>defer</code> 语句按照后进先出（LIFO）的顺序执行，即最后注册的函数最先执行。这使得 <code>defer</code> 在 Go 中成为一个强大而简洁的工具，用于确保资源管理和代码执行顺序的可靠性。</p><p>以下是一个示例，展示了一个函数内有多个 <code>defer</code> 语句的情况：</p><pre><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Start&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// 第一个 defer，注册的函数将在 main 函数执行结束后执行</span>
    <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Deferred statement 1&quot;</span><span class="token punctuation">)</span>
 	
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Middle&quot;</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 第二个 defer</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Deferred statement 2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;End&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在这个示例中，<code>main</code> 函数内有两个 <code>defer</code> 语句，它们分别注册了两个匿名函数。当 <code>main</code> 函数执行时，它们会按照 LIFO 的顺序执行。因此，输出顺序将是：</p><ol><li><code>Start</code></li><li><code>End</code></li><li><code>Middle</code></li><li><code>Deferred statement 2</code></li><li><code>Deferred statement 1</code></li></ol><h3 id="哪些函数可以defer" tabindex="-1"><a class="header-anchor" href="#哪些函数可以defer"><span>哪些函数可以defer</span></a></h3><p>Go语言中除了有自定义的函数或方法，还有内置函数。下面是Go语言内置函数的完整列表：</p><pre><code>append cap close complex copy delete imag len
make new panic print println real recover
</code></pre><p>内置函数是否都能作为deferred函数呢？</p><p>append、cap、len、make、new等内置函数是不可以直接作为deferred函数的，而close、copy、delete、print、recover等可以。</p><p>对于那些不能直接作为deferred函数的内置函数，我们可以使用一个包裹它的匿名函数来间接满足要求。以append为例：</p><pre><code class="language-go"><span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>但这么做有什么实际意义需要开发者自己把握。</p><h2 id="_1-3-receiver参数" tabindex="-1"><a class="header-anchor" href="#_1-3-receiver参数"><span>1.3. receiver参数</span></a></h2><p>Go语言虽然不支持经典的面向对象语法元素，比如类、对象、继承等，Go语言中的方法在声明形式上仅仅多了一个参数，Go称之为receiver参数。receiver参数是方法与类型之间的纽带。Go方法的一般声明形式如下：</p><pre><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>receiver T<span class="token comment">/*T) MethodName(参数列表) (返回值列表) {
    // 方法体
}
</span></code></pre><p>上面方法声明中的T称为receiver的基类型。通过receiver，上述方法被绑定到类型T上。换句话说，上述方法是类型T的一个方法，我们可以通过类型T或*T的实例调用该方法，如下面的伪代码所示：</p><pre><code class="language-go"><span class="token keyword">var</span> t T
t<span class="token punctuation">.</span><span class="token function">MethodName</span><span class="token punctuation">(</span>参数列表<span class="token punctuation">)</span>

<span class="token keyword">var</span> pt <span class="token operator">*</span>T <span class="token operator">=</span> <span class="token operator">&amp;</span>t
pt<span class="token punctuation">.</span><span class="token function">MethodName</span><span class="token punctuation">(</span>参数列表<span class="token punctuation">)</span>
</code></pre><p>Go方法具有如下特点。</p><p>1）方法名的首字母是否大写决定了该方法是不是导出方法。</p><p>2）方法定义要与类型定义放在同一个包内。由此我们可以推出：不能为原生类型（如int、float64、map等）添加方法，只能为自定义类型定义方法（示例代码如下）。</p><pre><code class="language-go"><span class="token comment">// 错误的做法</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token comment">// 编译器错误：cannot define new methods on non- local type int</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正确的做法</span>
<span class="token keyword">type</span> MyInt <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i MyInt<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>3）每个方法只能有一个receiver参数，不支持多receiver参数列表或变长receiver参数。一个方法只能绑定一个基类型，Go语言不支持同时绑定多个类型的方法。</p><p>4）receiver参数的基类型本身不能是指针类型或接口类型，下面的示例展示了这点：</p><pre><code class="language-go"><span class="token keyword">type</span> MyInt <span class="token operator">*</span><span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r MyInt<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token comment">// 编译器错误：invalid receiver type MyInt (MyInt  is a pointer type)</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MyReader io<span class="token punctuation">.</span>Reader
<span class="token keyword">func</span> <span class="token punctuation">(</span>r MyReader<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 编译器错误：invalid receiver  type MyReader (MyReader is an  interface type)</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="_1-4-变长参数函数" tabindex="-1"><a class="header-anchor" href="#_1-4-变长参数函数"><span>1.4. 变长参数函数</span></a></h2><p>在Go语言中，可以使用变长参数函数（variadic functions）来处理可变数量的参数。变长参数函数可以接受任意数量的参数，这些参数被打包成一个切片（slice）传递给函数。这种特性非常有用，特别是当函数需要处理数量不确定的参数时。</p><p>下面是一个简单的示例，展示了如何在Go语言中使用变长参数函数：</p><pre><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token comment">// 变长参数函数</span>
<span class="token keyword">func</span> <span class="token function">sum</span><span class="token punctuation">(</span>nums <span class="token operator">...</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    total <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> nums <span class="token punctuation">{</span>
        total <span class="token operator">+=</span> num
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用变长参数函数</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: 6</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: 15</span>

    <span class="token comment">// 也可以传递切片作为参数</span>
    numbers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>numbers<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: 15</span>
<span class="token punctuation">}</span>
</code></pre><p>在上面的示例中，sum函数是一个变长参数函数，它接受任意数量的int类型参数，并返回它们的总和。在main函数中，我们演示了如何调用sum函数并传递不同数量的参数或切片作为参数。</p><p>关键点：</p><p>在函数参数列表中，使用<code>...</code>语法指定一个参数是变长参数。 变长参数在函数内部以切片的形式表示。 可以传递不定数量的参数给变长参数函数。 也可以传递切片给变长参数函数，使用<code>...</code>操作符来展开切片。</p><p>使用变长参数函数时最容易出现的一个问题是实参与形参不匹配，比如下面这个例子：</p><pre><code class="language-go"><span class="token comment">// chapter4/sources/variadic_function_2.go</span>

<span class="token keyword">func</span> <span class="token function">dump</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Tony&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jim&quot;</span><span class="token punctuation">}</span>
    <span class="token function">dump</span><span class="token punctuation">(</span>s<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>运行这段代码：</p><pre><code>$ go run variadic_function_2.go
./variadic_function_2.go:14:6: cannot use s (type []string) as type []interface {} in argument to dump
</code></pre><p>我们看到，编译器给出了“类型不匹配”的错误。dump函数的变长参数类型为<code>...interface{}</code>，因此匹配该形参的要么是<code>interface{}</code>类型的变量，要么为<code>t...</code>（t类型为<code>[]interface{}</code>）。在例子中给dump传入的实参为<code>s...</code>，但s的类型为<code>[]string</code>，并非<code>[]interface{}</code>，导致不匹配。</p><p>这里要注意的是，虽然<code>string</code>类型变量可以直接赋值给<code>interface{}</code>类型变量，但是<code>[]string</code>类型变量并不能直接赋值给<code>[]interface{}</code>类型变量。要消除编译错误，我们仅需将变量s的类型换为<code>[]interface{}</code>，见下面的代码：</p><pre><code class="language-go">
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot;Tony&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jim&quot;</span><span class="token punctuation">}</span>
    <span class="token function">dump</span><span class="token punctuation">(</span>s<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

$ <span class="token keyword">go</span> run variadic_function_2<span class="token punctuation">.</span><span class="token keyword">go</span>
Tony
John
Jim
</code></pre><p>不过有个例外，那就是Go内置的append函数，它支持通过下面的方式将字符串附加到一个字节切片后面：</p><pre><code class="language-go"><span class="token comment">// chapter4/sources/variadic_function_3.go</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token operator">...</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

$ <span class="token keyword">go</span> run variadic_function_3<span class="token punctuation">.</span><span class="token keyword">go</span>
hello
</code></pre><p>string类型本是不满足类型要求的（append本需要<code>[]byte...</code>），这算是Go编译器的一个优化，编译器自动将<code>string</code>隐式转换为了<code>[]byte</code>。</p><h2 id="_1-5-模拟函数重载" tabindex="-1"><a class="header-anchor" href="#_1-5-模拟函数重载"><span>1.5. 模拟函数重载</span></a></h2><p>在Go语言中并不支持像一些其他语言（如C++、Java）中那样的函数重载，也就是不能有多个同名函数但参数列表不同的情况。但是可以模拟函数重载的效果。</p><ul><li><p>如果要重载的函数的参数都是相同类型的，仅参数的个数是变化的，那么变长参数函数可以轻松对应；</p></li><li><p>如果参数类型不同且个数可变，那么我们还要结合<code>interface{}</code>类型的特性。一个例子：</p><pre><code class="language-go">
<span class="token keyword">func</span> <span class="token function">concat</span><span class="token punctuation">(</span>sep <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token builtin">string</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>
        <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            result <span class="token operator">+=</span> sep
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int8</span><span class="token punctuation">,</span> <span class="token builtin">int16</span><span class="token punctuation">,</span> <span class="token builtin">int32</span><span class="token punctuation">,</span> <span class="token builtin">int64</span><span class="token punctuation">,</span>
            <span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint8</span><span class="token punctuation">,</span> <span class="token builtin">uint16</span><span class="token punctuation">,</span> <span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token builtin">uint64</span><span class="token punctuation">:</span>
            result <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
            result <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">:</span>
            ints <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ints <span class="token punctuation">{</span>
                <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    result <span class="token operator">+=</span> sep
                <span class="token punctuation">}</span>
                result <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">:</span>
            strs <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
            result <span class="token operator">+=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>strs<span class="token punctuation">,</span> sep<span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;the argument type [%T] is not supported&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gopher&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;robot&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ai&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ml&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;hacker&quot;</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在上面这个例子中，我们定义了一个concat函数，该函数支持接受任意数量的整型、字符串、整型切片、字符串切片参数，并将输入的参数通过分隔符（sep）连接在一起。看main函数中对concat的调用，是不是有一种调用重载函数的感觉。</p></li></ul><h2 id="_1-6-功能选项" tabindex="-1"><a class="header-anchor" href="#_1-6-功能选项"><span>1.6. 功能选项</span></a></h2><p>在Go语言中，功能选项（Options）模式是一种常见的设计模式，用于在函数或方法中传递可变数量的配置选项。这种模式在标准库和许多第三方库中被广泛应用，可以使函数的参数更加灵活和可扩展。实现功能选项的一般方法：</p><ul><li>定义选项类型：通常是一个函数类型，它接受并修改某个配置选项。</li><li>定义主要函数：主要函数接受一个或多个选项类型的参数，并根据这些选项进行操作。 例子：</li></ul><pre><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token comment">// 选项类型</span>
<span class="token keyword">type</span> Options <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Option1 <span class="token builtin">string</span>
    Option2 <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Options<span class="token punctuation">)</span>

<span class="token comment">// 主要函数，接受选项参数</span>
<span class="token keyword">func</span> <span class="token function">ProcessOptions</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">:=</span> <span class="token operator">&amp;</span>Options<span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// 应用所有选项</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在这里使用选项进行操作</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Option1:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>Option1<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Option2:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>Option2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 选项函数，用于设置 Option1</span>
<span class="token keyword">func</span> <span class="token function">WithOption1</span><span class="token punctuation">(</span>val <span class="token builtin">string</span><span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        o<span class="token punctuation">.</span>Option1 <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 选项函数，用于设置 Option2</span>
<span class="token keyword">func</span> <span class="token function">WithOption2</span><span class="token punctuation">(</span>val <span class="token builtin">int</span><span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        o<span class="token punctuation">.</span>Option2 <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用功能选项模式调用函数</span>
    <span class="token function">ProcessOptions</span><span class="token punctuation">(</span><span class="token function">WithOption1</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">WithOption2</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在这个例子中，<code>Options</code>结构体定义了需要配置的选项，<code>Option</code>是一个函数类型，用于修改这些选项。<code>WithOption1</code>和<code>WithOption2</code>是两个选项函数，分别用于设置<code>Option1</code>和<code>Option2</code>。<code>ProcessOptions</code>函数是主要函数，接受一个或多个选项参数，并根据这些选项进行操作。</p><p>通过使用功能选项模式，可以灵活地向函数传递各种不同的配置选项，并根据需要调整函数的行为。这种模式在Go语言中经常用于简化函数接口，提高代码的可读性和可维护性。</p><h2 id="_1-7-go常见的并发模式" tabindex="-1"><a class="header-anchor" href="#_1-7-go常见的并发模式"><span>1.7. Go常见的并发模式</span></a></h2><p>在语言层面，Go针对CSP模型提供了三种并发原语。</p><ul><li>goroutine：对应CSP模型中的P，封装了数据的处理逻辑，是Go运行时调度的基本执行单元。</li><li>channel：对应CSP模型中的输入/输出原语，用于goroutine之间的通信和同步。</li><li>select：用于应对多路输入/输出，可以让goroutine同时协调处理多个channel操作。</li></ul><h3 id="创建模式" tabindex="-1"><a class="header-anchor" href="#创建模式"><span>创建模式</span></a></h3><p>Go语言使用go关键字+函数/方法创建goroutine：</p><pre><code class="language-go"><span class="token keyword">go</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;I am a goroutine&quot;</span><span class="token punctuation">)</span>
 
<span class="token comment">// $GOROOT/src/net/http/server.go</span>
c <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">newConn</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
<span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>connCtx<span class="token punctuation">)</span>
</code></pre><p>但在稍复杂一些的并发程序中，需要考虑通过CSP模型输入/输出原语的承载体channel，在goroutine之间建立联系。为了满足这一需求，我们通常使用下面的方式来创建goroutine：</p><pre><code class="language-go"><span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> T <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> T<span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用channel变量c(通过闭包方式)与调用spawn的goroutine通信</span>
        <span class="token operator">...</span>
        <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用channel变量c与新创建的goroutine通信</span>
<span class="token punctuation">}</span>
</code></pre><p>以上方式在内部创建一个goroutine并返回一个channel类型变量的函数，这是Go中最常见的goroutine创建模式。</p><p>spawn函数创建的新goroutine与调用spawn函数的goroutine之间通过一个channel建立起了联系：两个goroutine可以通过这个channel进行通信。spawn函数的实现得益于channel作为Go语言一等公民（first-class citizen）的存在：channel可以像变量一样被初始化、传递和赋值。上面例子中的spawn只返回了一个channel变量，大家可以根据需要自行定义返回的channel个数和用途。</p><h3 id="退出模式" tabindex="-1"><a class="header-anchor" href="#退出模式"><span>退出模式</span></a></h3><p>goroutine的使用代价很低，Go官方推荐多使用goroutine。在多数情况下，我们无须考虑对goroutine的退出进行控制：goroutine的执行函数返回，即意味着goroutine退出。但一些常驻的后台服务程序可能会对goroutine有着优雅退出的要求，在这里我们就分类说明一下goroutine的几种退出模式。</p><h4 id="_1-分离模式" tabindex="-1"><a class="header-anchor" href="#_1-分离模式"><span>（1）分离模式</span></a></h4><p>这里借鉴了一些线程模型中的术语，比如分离（detached）模式。分离模式是使用最为广泛的goroutine退出模式。对于分离的goroutine，创建它的goroutine不需要关心它的退出，这类goroutine在启动后即与其创建者彻底分离，其生命周期与其执行的主函数相关，函数返回即goroutine退出。这类goroutine有两个常见用途。</p><p>1）一次性任务：顾名思义，新创建的goroutine用来执行一个简单的任务，执行后即退出。</p><p>2）常驻后台执行一些特定任务，如监视（monitor）、观察（watch）等。其实现通常采用<code>for {...}</code>或<code>for { select{...} }</code>代码段形式，并多以定时器（timer）或事件（event）驱动执行。</p><h4 id="_2-join模式" tabindex="-1"><a class="header-anchor" href="#_2-join模式"><span>（2）join模式</span></a></h4><p>在线程模型中，父线程可以通过<code>pthread_join</code>来等待子线程结束并获取子线程的结束状态。在Go中，我们有时候也有类似的需求：goroutine的创建者需要等待新goroutine结束。笔者为这样的goroutine退出模式起名为“join模式”。</p><p>① 等待一个goroutine退出</p><p>我们从一个简单的场景开始，先来看看如何等待一个goroutine结束。下面是模拟该场景的一段示例代码：</p><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-1.go</span>
<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    interval<span class="token punctuation">,</span> ok <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span>
        c <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     done <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
     <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn a worker goroutine&quot;</span><span class="token punctuation">)</span>
     <span class="token operator">&lt;-</span>done
     <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;worker done&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在上面的代码中，spawn函数使用典型的goroutine创建模式创建了一个goroutine，main goroutine作为创建者通过spawn函数返回的channel与新goroutine建立联系，这个channel的用途就是在两个goroutine之间建立退出事件的“信号”通信机制。main goroutine在创建完新goroutine后便在该channel上阻塞等待，直到新goroutine退出前向该channel发送了一个信号。运行该示例：</p><pre><code class="language-bash">$ go run go-concurrency-pattern-1.go
spawn a worker goroutine
worker <span class="token keyword">done</span>
</code></pre><p>② 获取goroutine的退出状态</p><p>如果新goroutine的创建者不仅要等待goroutine的退出，还要精准获取其结束状态，同样可以通过自定义类型的channel来实现这一场景需求。下面是基于上面的代码改造后的示例：</p><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-2.go</span>

<span class="token keyword">var</span> OK <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid args&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    interval<span class="token punctuation">,</span> ok <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid interval arg&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> OK
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">&lt;-</span> <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    done <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn worker1&quot;</span><span class="token punctuation">)</span>
    err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>done
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;worker1 done:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    done <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn worker2&quot;</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> <span class="token operator">&lt;-</span>done
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;worker2 done:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我们将channel中承载的类型由<code>struct{}</code>改为了error，这样channel承载的信息就不只是一个信号了，还携带了有价值的信息：新goroutine的结束状态。运行上述示例：</p><pre><code class="language-bash"><span class="token variable">$go</span> run go-concurrency-pattern-2.go
spawn worker1
worker1 done: ok
spawn worker2
worker2 done: invalid args
</code></pre><p>③ 等待多个goroutine退出</p><p>在有些场景中，goroutine的创建者可能会创建不止一个goroutine，并且需要等待全部新goroutine退出。可以通过Go语言提供的<code>sync.WaitGroup</code>实现等待多个goroutine退出的模式：</p><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-3.go</span>
<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    interval<span class="token punctuation">,</span> ok <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;worker-%d:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token function">f</span><span class="token punctuation">(</span>args<span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span>
            wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// worker done!</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        c <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    done <span class="token operator">:=</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn a group of workers&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;-</span>done
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;group workers done&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>我们看到，通过<code>sync.WaitGroup</code>，<code>spawnGroup</code>每创建一个goroutine都会调用<code>wg.Add(1)</code>，新创建的goroutine会在退出前调用<code>wg.Done</code>。在<code>spawnGroup</code>中还创建了一个用于监视的goroutine，该goroutine调用<code>sync.WaitGroup</code>的Wait方法来等待所有goroutine退出。在所有新创建的goroutine退出后，Wait方法返回，该监视goroutine会向<code>done</code>这个channel写入一个信号，这时<code>main</code> goroutine才会从阻塞在<code>done</code> channel上的状态中恢复，继续往下执行。</p><pre><code class="language-bash"><span class="token variable">$go</span> run go-concurrency-pattern-3.go 
spawn a group of workers
worker-2: <span class="token keyword">done</span>
worker-1: <span class="token keyword">done</span>
worker-0: <span class="token keyword">done</span>
worker-4: <span class="token keyword">done</span>
worker-3: <span class="token keyword">done</span>
group workers <span class="token keyword">done</span>
</code></pre><p>④ 支持超时机制的等待</p><p>有时候，我们不想无限阻塞等待所有新创建goroutine的退出，而是仅等待一段合理的时间。如果在这段时间内goroutine没有退出，则创建者会继续向下执行或主动退出。下面的示例代码在等待多个goroutine退出的例子之上增加了超时机制：</p><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-4.go</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    done <span class="token operator">:=</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> worker<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn a group of workers&quot;</span><span class="token punctuation">)</span>
    
    timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>timer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;wait group workers exit timeout!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;group workers done&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>在上述代码中，我们通过一个定时器（<code>time.Timer</code>）设置了超时等待时间，并通过select原语同时监听<code>timer.C</code>和<code>done</code>这两个channel，哪个先返回数据就执行哪个case分支。</p><pre><code class="language-bash">$ go run go-concurrency-pattern-4.go
spawn a group of workers
<span class="token function">wait</span> group workers <span class="token builtin class-name">exit</span> timeout<span class="token operator">!</span>
</code></pre><h4 id="_3-notify-and-wait模式" tabindex="-1"><a class="header-anchor" href="#_3-notify-and-wait模式"><span>（3）notify-and-wait模式</span></a></h4><p>在前面的几个场景中，goroutine的创建者都是在被动地等待着新goroutine的退出。但很多时候，goroutine创建者需要主动通知那些新goroutine退出，尤其是当main goroutine作为创建者时。main goroutine退出意味着Go程序的终止，而粗暴地直接让main goroutine退出的方式可能会导致业务数据损坏、不完整或丢失。我们可以通过notify-and-wait（通知并等待）模式来满足这一场景的要求。虽然这一模式也不能完全避免损失，但是它给了各个goroutine一个挽救数据的机会，从而尽可能减少损失。</p><p>① 通知并等待一个goroutine退出</p><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-5.go</span>
<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> job <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token comment">// 模拟job channel</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> j <span class="token operator">:=</span> <span class="token operator">&lt;-</span>job<span class="token punctuation">:</span>
                <span class="token function">f</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>quit<span class="token punctuation">:</span>
                quit <span class="token operator">&lt;-</span> <span class="token string">&quot;ok&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> quit
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    quit <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn a worker goroutine&quot;</span><span class="token punctuation">)</span>
    
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    
    <span class="token comment">// 通知新创建的goroutine退出</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;notify the worker to exit...&quot;</span><span class="token punctuation">)</span>
    quit <span class="token operator">&lt;-</span> <span class="token string">&quot;exit&quot;</span>
    
    timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> status <span class="token operator">:=</span> <span class="token operator">&lt;-</span>quit<span class="token punctuation">:</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;worker done:&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>timer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;wait worker exit timeout&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>在上述示例代码中，使用创建模式创建goroutine的spawn函数返回的channel的作用发生了变化，从原先的只是用于新goroutine发送退出信号给创建者，变成了一个双向的数据通道：既承载创建者发送给新goroutine的退出信号，也承载新goroutine返回给创建者的退出状态。</p><pre><code class="language-bash"><span class="token variable">$go</span> run go-concurrency-pattern-5.go 
spawn a worker goroutine
notify the worker to exit<span class="token punctuation">..</span>.
worker done: ok
</code></pre><p>② 通知并等待多个goroutine退出</p><p>Go语言的channel有一个特性是，当使用close函数关闭channel时，所有阻塞到该channel上的goroutine都会得到通知。我们就利用这一特性实现满足这一场景的模式：</p><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-6.go</span>
<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    job <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 保证wg.Done在goroutine退出前被执行</span>
            name <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;worker-%d:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">{</span>
                j<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>job
                <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                    <span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 执行这个job</span>
                <span class="token function">worker</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;-</span>quit
        <span class="token function">close</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token comment">// 广播给所有新goroutine</span>
        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        quit <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> quit
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    quit <span class="token operator">:=</span> <span class="token function">spawnGroup</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> worker<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spawn a group of workers&quot;</span><span class="token punctuation">)</span>
    
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token comment">// 通知 worker goroutine 组退出</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;notify the worker group to exit...&quot;</span><span class="token punctuation">)</span>
    quit <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>timer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;wait group workers exit timeout!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>quit<span class="token punctuation">:</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;group workers done&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>此时各个worker goroutine监听job channel，当创建者关闭job channel时，通过“comma ok”模式获取的ok值为false，也就表明该channel已经被关闭，于是worker goroutine执行退出逻辑（退出前<code>wg.Done()</code>被执行）。</p><pre><code class="language-bash"><span class="token variable">$go</span> run go-concurrency-pattern-6.go
spawn a group of workers
notify the worker group to exit<span class="token punctuation">..</span>.
worker-3: <span class="token keyword">done</span>
worker-0: <span class="token keyword">done</span>
worker-4: <span class="token keyword">done</span>
worker-2: <span class="token keyword">done</span>
worker-1: <span class="token keyword">done</span>
group workers <span class="token keyword">done</span>
</code></pre><h3 id="管道模式" tabindex="-1"><a class="header-anchor" href="#管道模式"><span>管道模式</span></a></h3><pre><code class="language-go"><span class="token comment">// chapter6/sources/go-concurrency-pattern-8.go</span>
<span class="token keyword">func</span> <span class="token function">newNumGenerator</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> start<span class="token operator">+</span>count<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            c <span class="token operator">&lt;-</span> i
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">filterOdd</span><span class="token punctuation">(</span>in <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> in<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> in<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">square</span><span class="token punctuation">(</span>in <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> in <span class="token operator">*</span> in<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">spawn</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
            r<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
                out <span class="token operator">&lt;-</span> r
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    in <span class="token operator">:=</span> <span class="token function">newNumGenerator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    out <span class="token operator">:=</span> <span class="token function">spawn</span><span class="token punctuation">(</span>square<span class="token punctuation">,</span> <span class="token function">spawn</span><span class="token punctuation">(</span>filterOdd<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> out <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="_1-8-有缓和无缓channel" tabindex="-1"><a class="header-anchor" href="#_1-8-有缓和无缓channel"><span>1.8. 有缓和无缓channel</span></a></h2><blockquote><p>这里全部来自chatGPT</p></blockquote><h3 id="特点" tabindex="-1"><a class="header-anchor" href="#特点"><span>特点</span></a></h3><p>在Go语言中，channel（通道）是用于在 Go 协程之间进行通信和同步的重要机制。Channel 可以是有缓冲的（buffered）或无缓冲的（unbuffered），它们有不同的特性和适用场景。</p><p>无缓冲 channel：</p><ul><li>无缓冲 channel 在发送数据和接收数据时是同步的，发送操作和接收操作是阻塞的。</li><li>当一个数据被发送到无缓冲 channel 时，发送方会阻塞直到有其他 Go 协程从该 channel 接收数据。</li><li>同样，当数据被接收时，接收方会阻塞直到有其他 Go 协程向 channel 发送数据。</li></ul><pre><code class="language-go">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个无缓冲 channel</span>
</code></pre><p>有缓冲 channel：</p><ul><li>有缓冲 channel 具有一定的容量，允许在 channel 中存储一定数量的数据项。</li><li>当往一个有缓冲 channel 发送数据时，如果 channel 还未满，发送操作是非阻塞的；当 channel 满时发送操作会阻塞。</li><li>同样，当从一个有缓冲 channel 接收数据时，如果 channel 中有数据，接收操作是非阻塞的；当 channel 空时接收操作会阻塞。</li></ul><pre><code class="language-go">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个容量为 5 的有缓冲 channel</span>
</code></pre><h3 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景"><span>使用场景</span></a></h3><p><strong>无缓冲 channel ：</strong></p><ol><li><p>同步数据传递：在两个 Go 协程之间进行数据传递，确保数据的顺序性和同步性。</p><pre><code class="language-go">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">:=</span> <span class="token number">42</span>
    ch <span class="token operator">&lt;-</span> data <span class="token comment">// 将数据发送到无缓冲 channel</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch <span class="token comment">// 接收从 channel 发来的数据</span>
</code></pre></li><li><p>信号量：控制并发操作的数量，确保在特定时刻只有有限数量的并发操作在执行。</p><pre><code class="language-go">sem <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 限制同时执行的并发操作数量为 5</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sem <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 获取信号量</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&lt;-</span>sem <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 释放信号量</span>
        <span class="token comment">// 执行并发操作</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></li></ol><p><strong>有缓冲 channel ：</strong></p><ol><li><p>生产者-消费者模型：用于在生产者和消费者之间进行解耦，提高程序的吞吐量。</p><pre><code class="language-go">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 有缓冲 channel，缓冲区大小为 10</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        ch <span class="token operator">&lt;-</span> i <span class="token comment">// 生产数据</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
        <span class="token comment">// 消费数据</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li><li><p><strong>异步结果处理</strong>：用于异步处理任务的结果，减少因为发送或接收操作阻塞而导致的性能问题。</p><pre><code class="language-go">resultCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 有缓冲 channel，用于接收异步操作的结果</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异步操作</span>
    resultCh <span class="token operator">&lt;-</span> <span class="token number">42</span> <span class="token comment">// 发送结果到 channel</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>resultCh <span class="token comment">// 接收异步操作的结果</span>
</code></pre></li></ol><p>这些场景只是使用无缓冲和有缓冲 channel 的一部分示例。根据具体的需求，合理选择适当类型的 channel 可以提高程序的效率和可维护性，同时确保并发操作的正确性。</p><h2 id="_1-9-cgo-go调用c代码" tabindex="-1"><a class="header-anchor" href="#_1-9-cgo-go调用c代码"><span>1.9. cgo-Go调用C代码</span></a></h2><p>在 Go 语言中，CGO 是 Go 语言提供的一种特性，用于在 Go 代码中调用 C 语言代码。通过 CGO，可以很方便地在 Go 代码中集成现有的 C 代码库，或者利用 C 语言的性能优势来编写高性能的代码片段。</p><p>使用 CGO 的一般流程包括以下步骤：</p><ol><li><strong>编写 C 代码</strong>：首先需要编写需要调用的 C 代码，可以是一个简单的 C 函数或者一个 C 语言库。</li><li><strong>创建 C 头文件</strong>：为了在 Go 代码中调用 C 函数，需要创建一个 C 头文件，用于声明 C 函数的原型。</li><li><strong>在 Go 代码中使用 CGO</strong>：在 Go 代码中通过 <code>import &quot;C&quot;</code> 来引入 CGO，然后通过 <code>// #cgo</code> 指令告诉编译器去链接 C 代码。</li><li><strong>调用 C 函数</strong>：在 Go 代码中就可以像调用普通 Go 函数一样调用 C 函数，通过 CGO 技术实现 Go 与 C 语言的互操作。</li></ol><p>以下是一个更详细的示例，展示如何使用 CGO 在 Go 中调用一个简单的 C 函数来实现字符串加密和解密功能。</p><p><strong>1. 编写 C 代码</strong></p><p>首先，我们编写两个简单的 C 函数，一个用于加密字符串，另一个用于解密字符串。</p><pre><code class="language-c"><span class="token comment">// encrypt.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token operator">*</span>str <span class="token operator">^</span> <span class="token number">31</span><span class="token punctuation">;</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// decrypt.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token operator">*</span>str <span class="token operator">^</span> <span class="token number">31</span><span class="token punctuation">;</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>2. 创建 C 头文件 <code>crypto.h</code></strong></p><p>创建一个头文件 <code>crypto.h</code>，用于声明 C 函数的原型。</p><pre><code class="language-c"><span class="token comment">// crypto.h</span>
<span class="token keyword">void</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>3. 编写 Go 代码</strong></p><p>接下来，我们编写 Go 代码，通过 CGO 调用上述的 C 函数来加密和解密字符串。</p><pre><code class="language-go"><span class="token keyword">package</span> main

<span class="token comment">/*
#cgo CFLAGS: -g -Wall
#cgo LDFLAGS: -lm
#include &quot;crypto.h&quot;
*/</span>
<span class="token keyword">import</span> <span class="token string">&quot;C&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    message <span class="token operator">:=</span> <span class="token string">&quot;Hello, world!&quot;</span>

    <span class="token comment">// Encrypt the message</span>
    cMessage <span class="token operator">:=</span> C<span class="token punctuation">.</span><span class="token function">CString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> C<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>cMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
    C<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>cMessage<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Encrypted message: %s\n&quot;</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span><span class="token function">GoString</span><span class="token punctuation">(</span>cMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// Decrypt the message</span>
    C<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>cMessage<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Decrypted message: %s\n&quot;</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span><span class="token function">GoString</span><span class="token punctuation">(</span>cMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在这个示例中，Go 代码通过 <code>import &quot;C&quot;</code> 引入 CGO，然后使用 <code>// #cgo</code> 指令来指定编译选项。在 <code>main</code> 函数中，我们首先将 Go 字符串转换为 C 字符串，然后调用 C 函数来加密和解密字符串，最后将结果打印出来。</p><p><strong>4. 构建和运行程序</strong></p><p>在包含以上文件的目录中，可以通过以下命令构建和运行这个示例程序：</p><pre><code class="language-bash">go build <span class="token parameter variable">-o</span> crypto
./crypto
</code></pre><p>程序应该输出以下内容：</p><pre><code>Encrypted message: LQYYX;#rNXVX
Decrypted message: Hello, world!
</code></pre></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/echo0d/DailyNotes/edit/main/src/develop/Go/ImprovingGo/1_GoFinal.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: echo0d@163.com">echo0d</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link active prev" href="/DailyNotes/develop/Go/ImprovingGo/" aria-label="Go语言精进"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Go语言精进</div></a><a class="route-link nav-link next" href="/DailyNotes/develop/Go/ImprovingGo/2_fscanPro.html" aria-label="2. Go练习-fscan"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">2. Go练习-fscan<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">听君一席话，如听一席话</div><div class="vp-copyright">Copyright © 2025 echo0d </div></footer></div><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/DailyNotes/assets/app-BoR_3jx9.js" defer></script>
  </body>
</html>
