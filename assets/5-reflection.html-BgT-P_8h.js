import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as t,o as p}from"./app-BLgHyi2a.js";const o="/DailyNotes/assets/image-20230730104124182-f93DBzop.png",e="/DailyNotes/assets/image-20230730104206414-CfBFtK1f.png",c="/DailyNotes/assets/image-20230730104235263-C4PPL2vw.png",l="/DailyNotes/assets/image-20230730104302183-KA4h_7Ay.png",u="/DailyNotes/assets/image-20230730104316897-jVhAC1H-.png",i="/DailyNotes/assets/image-20230730104027695-DgnANi3v.png",k="/DailyNotes/assets/image-20230831215107300-C7tTuKJ8.png",d={};function r(m,n){return p(),a("div",null,[...n[0]||(n[0]=[t(`<h1 id="_5-java-代码审计基础-反射" tabindex="-1"><a class="header-anchor" href="#_5-java-代码审计基础-反射"><span>5-Java 代码审计基础-反射</span></a></h1><blockquote><p>Java-Reflection（JAVA 反射）是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够通过 Java-Reflection 来调用它的任意方法和属性（不管是公共的还是私有的），这种动态获取信息以及动态调用对象方法的行为被称为 java 的反射机制。</p></blockquote><blockquote><p>Java 反射机制是 Java 动态性中最为重要的体现，利用反射机制我们可以轻松的实现 Java 类的动态调用。Java 的大部分框架都是采用了反射机制来实现的(如:<code>Spring MVC</code>、<code>ORM框架</code>等)，Java 反射在编写漏洞利用代码、代码审计、绕过 RASP 方法限制等中起到了至关重要的作用。</p></blockquote><blockquote><p>反射的用途很广泛。在开发过程中使用 Eclipse、IDEA 等开发工具时，当我们输入一个对象或类并想调用它的属性或方法时，编译器会自动列出它的属性或方法，这是通过反射实现的；再如，JavaBean 和 JSP 之间的调用也是通过反射实现的。反射最重要的用途是开发各种通用框架，如上文中提到的 Spring 框架以及 ORM 框架，都是通过反射机制来实现的。</p></blockquote><h2 id="_1、反射获取类对象" tabindex="-1"><a class="header-anchor" href="#_1、反射获取类对象"><span>1、反射获取类对象</span></a></h2><p>获取类对象的方式有如下四种：</p><ol><li><p><code>Class.forName</code></p><p>如果要使用<code>Class</code>类中的方法获取类对象，就需要使用<code>forName() </code>方法，只要有类名称即可，使用更为方便，扩展性更强。例如在配置 JDBC 的时候，经常采用这种方法。</p></li><li><p><code>类名.class </code>直接获取</p><p>任何数据类型都具备静态的属性，因此可以使用<code>.class</code>直接获取其对应的 Class 对象。这种方法相对简单，但要用到类中的静态成员</p></li><li><p><code>类名.getClass </code></p><p>可以通过 <code>Object </code>类中的 <code>getClass() </code>方法来获取字节码对象，不过这种方法较为烦琐，必须要明确具体的类，然后创建对象。</p></li><li><p><code>classLoader.loadClass(&quot;完整类名&quot;); </code></p><p>其中<code>classloader</code>需要继承了<code>ClassLoader</code>的类实例化。<code>loadClass() </code>方法与<code>forName()</code>方法类似，只要有类名称即可，区别在于<code>forName()</code>的静态方法 JVM 会装载类，并且执行<code>static()</code>中的代码；而<code>loadClass() </code>不会执行<code>static()</code>中的代码。</p></li></ol><p>以上四种方法的具体实现代码如下：</p><p><strong>ps</strong> 继承<code>ClassLoder</code>是为了第四种方法的 name5，其余方法不需要继承</p><pre><code class="language-java"><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> : echo0d
 * <span class="token keyword">@date</span> : 2023/7/29 17:50
 * @Description: 获取类对象
 */</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetClassName</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>  <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
<span class="token comment">//        1: forname()</span>
        <span class="token class-name">Class</span> name1 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Runtime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2: .class</span>
        <span class="token class-name">Class</span> name2 <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3: getClass()</span>
        <span class="token class-name">Runtime</span> rt <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> name3 <span class="token operator">=</span> rt<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        4: loadClass()</span>
        <span class="token class-name">Class</span> name4 <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Runtime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GetClassName</span> <span class="token class-name">TestClassLoader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> name5 <span class="token operator">=</span> <span class="token class-name">TestClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Runtime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name5<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><p>执行结果如下：</p><figure><img src="`+o+`" alt="image-20230730104124182" tabindex="0" loading="lazy"><figcaption>image-20230730104124182</figcaption></figure><h2 id="_2、反射获取类方法" tabindex="-1"><a class="header-anchor" href="#_2、反射获取类方法"><span>2、反射获取类方法</span></a></h2><p>反射获取类方法的方式：</p><ol><li><p><code>getDeclaredMethods()</code>方法</p><p><code>getDeclaredMethods() </code>方法返回类自身或接口自身声明的所有方法，包括 public、protected、private 和默认方法，但<strong>不包括继承的方法</strong>。</p></li><li><p><code>getMethods()</code>方法</p><p><code>getMethods()</code>方法返回某个类的所有 public 方法，<strong>包括其继承类的 public 方法</strong>。</p></li><li><p><code>getMethod()</code>方法</p><p><code>getMethod() </code>方法只能返回一个特定的方法（如<code>Runtime</code> 类中的<code>exec()</code>方法），该方法的第一个参数为方法名称，后面的参数为方法的参数对应 Class 的对象。</p></li><li><p><code>getDeclaredMethod()</code>方法。</p><p><code>getDeclaredMethod()</code>方法与<code>getMethod()</code>类似，也只能返回一个特定的方法，参数同上。</p></li></ol><p>具体代码如下：</p><pre><code class="language-java"><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> : echo0d
 * <span class="token keyword">@date</span> : 2023/7/29 18:55
 * @Description : 获取类方法
 */</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetClassMethod</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span> name <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Runtime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        1. getDeclaredMethods()</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> declaredMethods <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getDeclaredMethods()方法获取类方法：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m<span class="token operator">:</span>declaredMethods<span class="token punctuation">)</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2. getMethods()</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getMethods()获取类方法：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m<span class="token operator">:</span>methods<span class="token punctuation">)</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3. getMethod()</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;exec&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getMethod()获取exec方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        4. getDeclaredMethod</span>
        <span class="token class-name">Method</span> declaredMethod <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;exec&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getDeclaredMethod()获取exec方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>declaredMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><p>执行结果：</p><p><code>getDeclaredMethods()</code>方法</p><figure><img src="`+e+'" alt="image-20230730104206414" tabindex="0" loading="lazy"><figcaption>image-20230730104206414</figcaption></figure><p><code>getMethods()</code>方法</p><figure><img src="'+c+'" alt="image-20230730104235263" tabindex="0" loading="lazy"><figcaption>image-20230730104235263</figcaption></figure><figure><img src="'+l+'" alt="image-20230730104302183" tabindex="0" loading="lazy"><figcaption>image-20230730104302183</figcaption></figure><p><code>getDeclaredMethod()</code>方法与<code>getMethod()</code></p><figure><img src="'+u+`" alt="image-20230730104316897" tabindex="0" loading="lazy"><figcaption>image-20230730104316897</figcaption></figure><p><strong>下面对<code>getMethods()</code>与<code>getDeclaredMethods()</code>的区别进行代码验证</strong>，首先明确二者区别：</p><p><code>getMethods()</code>：获取当前类或父类或父接口的 public 修饰的字段（JDK1.8 中还包含接口中 default 修饰的方法，因为在 JDK1.8 环境下，接口中使用 default 修饰的方法，在编译后会变成 public 修饰的，可用反编译进行验证。）</p><p><code>getDeclaredMethods()</code>： 获取当前类的所有方法(包括 protected/默认/private 修饰的方法；不包括父类 、接口 public 修饰的方法)</p><p><strong>1、创建接口和类</strong></p><p>创建一个 ReflectInterface 接口，里面有 3 个方法：</p><pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReflectInterface</span> <span class="token punctuation">{</span>

	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">defaultMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">void</span> <span class="token function">voidMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><p>创建一个 Parent 类，有四种 Java 权限修饰的方法（以 p**11 格式）：</p><pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ParentPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token class-name">ParentProtected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">void</span> <span class="token class-name">ParentVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token class-name">ParentPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>创建一个 Child 类，实现 ReflectInterface 接口，继承 Parent 类， 同时有四种 Java 权限修饰的方法（以 c**22 格式）：</p><pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token keyword">implements</span> <span class="token class-name">ReflectInterface</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ChildPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token class-name">ChildProtected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">void</span> <span class="token class-name">ChildVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token class-name">ChildPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>2、测试类</strong></p><pre><code class="language-java"><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> : echo0d
 * <span class="token keyword">@date</span> : 2023/7/30 10:30
 * @Description :
 */</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestReflect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span><span class="token punctuation">&gt;</span></span> childClass <span class="token operator">=</span> <span class="token class-name">Child</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> childClass<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;测试getMethods()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m<span class="token operator">:</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span><span class="token punctuation">&gt;</span></span> childClass <span class="token operator">=</span> <span class="token class-name">Child</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> childClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;测试getDeclaredMethods()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m<span class="token operator">:</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><p>输出结果如下：</p><figure><img src="`+i+`" alt="image-20230730104027695" tabindex="0" loading="lazy"><figcaption>image-20230730104027695</figcaption></figure><p><code>getMethods()</code>方法输出结果：共有 13 个。</p><ul><li>第 1 个为当前类 public 方法</li><li>第 2 个为<code>Parent</code>类即父类的 public 方法</li><li>第 3 至 11 共 9 个方法为 <code>Object</code>类的 public 方法</li><li>第 12 至 13 个为<code>ReflectInterface</code>接口的 pubilc 和 default 方法</li></ul><p><code>getDeclaredMethods()</code>方法输出结果：当前类的全部方法，</p><h2 id="_3、反射获取类成员变量" tabindex="-1"><a class="header-anchor" href="#_3、反射获取类成员变量"><span>3、反射获取类成员变量</span></a></h2><p>反射获取类成员变量的方式：</p><ol><li><p><code>getDeclaredFields()</code>方法</p><p><code>getDeclaredFields()</code>方法能够获得类的成员变量数组，包括<code>public</code>、<code>private</code>和<code>proteced</code>，但是不包括父类的申明字段。</p></li><li><p><code>getFields()</code>方法</p><p><code>getFields()</code>能够获得某个类的所有的<code>public</code>字段，包括父类中的字段。</p></li><li><p><code>getDeclaredField()</code>方法</p><p>该方法与<code>getDeclaredFields</code>的区别是只能获得类的单个成员变量，这里我们仅想获得 Student 类中的 name 变量。</p></li></ol><p>具体代码如下：</p><pre><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> : echo0d
 * <span class="token keyword">@date</span> : 2023/8/1 21:30
 * @Description : 获取类成员变量
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetClassField</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> name <span class="token operator">=</span> student<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 实例化类对象后开始获取类成员变量</span>
        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> declaredFields <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;通过getDeclaredFields()获取成员变量&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Field</span> m<span class="token operator">:</span>declaredFields<span class="token punctuation">)</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;通过getFields()获取成员变量&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Field</span> m<span class="token operator">:</span>fields<span class="token punctuation">)</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> declaredField <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;通过getFields()获取成员变量&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>declaredField<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><p>运行结果如下：</p><figure><img src="`+k+`" alt="image-20230831215107300" tabindex="0" loading="lazy"><figcaption>image-20230831215107300</figcaption></figure><h2 id="_4、不安全的反射" tabindex="-1"><a class="header-anchor" href="#_4、不安全的反射"><span>4、不安全的反射</span></a></h2><p>如前所述，利用 Java 的反射机制，我们可以无视类方法、变量访问权限修饰符，调用任何类的任意方法、访问并修改成员变量值，但是这样做可能导致安全问题。如果一个攻击者能够通过应用程序创建意外的控制流路径，就有可能绕过安全检查发起相关攻击。</p><p>假设有一段代码如下：</p><pre><code class="language-java"><span class="token class-name">String</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Command</span> command <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Delect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelectCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Add&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
 command<span class="token punctuation">.</span><span class="token function">doAction</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>其中存在一个字段<code>name</code>，当获取用户请求的<code>name</code>字段后进行判断时，如果请求的是 <code>Delect</code> 操作，则执行<code>DelectCommand </code>函数；如果执行的是 <code>Add</code> 操作，则执行 <code>AddCommand</code> 函数；如果不是这两种操作，则执行其他代码。假如有开发者看到了这段代码，他认为可以使用 Java 的反射来重构此代码以减少代码行，如下所示。</p><pre><code class="language-java"><span class="token class-name">String</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span> <span class="token class-name">ComandClass</span> <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;Command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Command</span> command <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Command</span><span class="token punctuation">)</span> <span class="token class-name">CommandClass</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
command<span class="token punctuation">.</span><span class="token function">doAction</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>这样的重构看起来使代码行减少，消除了<code>if/else</code>块，而且可以在不修改命令分派器的情况下添加新的命令类型，但是如果没有对传入的<code>name</code>字段进行限制，就会实例化实现<code>Command</code>接口的任何对象，从而导致安全问题。</p><p>实际上，攻击者甚至不局限于本例中的<code>Command</code>接口对象，而是使用任何其他对象来实现，如调用系统中任何对象的默认构造函数，或者调用<code>Runtime</code>对象去执行系统命令，这可能导致远程命令执行出现漏洞，因此不安全的反射的危害性极大。</p>`,57)])])}const h=s(d,[["render",r]]),y=JSON.parse('{"path":"/CodeAudittutorial/1-JavaBase/5-reflection.html","title":"5-Java 代码审计基础-反射","lang":"zh-CN","frontmatter":{"category":"代码审计","tag":"Java","description":"5-Java 代码审计基础-反射 Java-Reflection（JAVA 反射）是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够通过 Java-Reflection 来调用它的任意方法和属性（不管是公共的还是私有的），这种动态获取信息以及动态调用对象方法的行为被称为 java 的反射机制。 Java 反射机制...","head":[["meta",{"property":"og:url","content":"https://echo0d.github.io/DailyNotes/CodeAudittutorial/1-JavaBase/5-reflection.html"}],["meta",{"property":"og:site_name","content":"echo0d-notes"}],["meta",{"property":"og:title","content":"5-Java 代码审计基础-反射"}],["meta",{"property":"og:description","content":"5-Java 代码审计基础-反射 Java-Reflection（JAVA 反射）是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够通过 Java-Reflection 来调用它的任意方法和属性（不管是公共的还是私有的），这种动态获取信息以及动态调用对象方法的行为被称为 java 的反射机制。 Java 反射机制..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-06-04T09:27:16.000Z"}],["meta",{"property":"article:author","content":"echo0d"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:modified_time","content":"2025-06-04T09:27:16.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"5-Java 代码审计基础-反射\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-06-04T09:27:16.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"echo0d\\",\\"url\\":\\"\\"}]}"]]},"headers":[{"level":2,"title":"1、反射获取类对象","slug":"_1、反射获取类对象","link":"#_1、反射获取类对象","children":[]},{"level":2,"title":"2、反射获取类方法","slug":"_2、反射获取类方法","link":"#_2、反射获取类方法","children":[]},{"level":2,"title":"3、反射获取类成员变量","slug":"_3、反射获取类成员变量","link":"#_3、反射获取类成员变量","children":[]},{"level":2,"title":"4、不安全的反射","slug":"_4、不安全的反射","link":"#_4、不安全的反射","children":[]}],"git":{"createdTime":1703388937000,"updatedTime":1749029236000,"contributors":[{"name":"echo0d","email":"echo0d@163.com","commits":6}]},"readingTime":{"minutes":7.26,"words":2178},"filePathRelative":"CodeAudittutorial/1-JavaBase/5-reflection.md","localizedDate":"2023年12月24日","excerpt":"\\n","autoDesc":true}');export{h as comp,y as data};
